var me=Object.defineProperty;var je=Object.getOwnPropertyDescriptor;var a=(r,e)=>me(r,"name",{value:e,configurable:!0});var P=(r,e,n,t)=>{for(var o=t>1?void 0:t?je(e,n):e,i=r.length-1,s;i>=0;i--)(s=r[i])&&(o=(t?s(e,n,o):s(o))||o);return t&&o&&me(e,n,o),o};var fe=navigator.userAgent.toLowerCase().indexOf("mac")!==-1;function oe(r){if(!r)return[];let e={backspace:"\u232B",shift:"\u21E7",meta:"\u2318",tab:"\u21B9",ctrl:"\u2303",arrowup:"\u2191",arrowdown:"\u2193",arrowleft:"\u2190",arrowright:"\u2192",enter:"\u23CE"};return r.toLowerCase().split("+").map(ge).map(t=>Object.keys(e).includes(t)?e[t]:t)}a(oe,"bindingSymbols");function ge(r){return!fe&&r==="meta"?"ctrl":r}a(ge,"filterKeyForNonMacMeta");var X=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let n of this.bindings)if(n.command===e)return n;return null}evaluateEvent(e){e:for(let n of this.bindings){let t=n.key.toLowerCase().split("+");if(t.pop()===e.key.toLowerCase()){for(let i of["shift","ctrl","alt","meta"]){let s=t.includes(i);if(!fe){if(i==="meta")continue;i==="ctrl"&&(s=t.includes("meta")||t.includes("ctrl"))}let d=e[`${ge(i)}Key`];if(!d&&s||d&&!s)continue e}return n}}return null}};a(X,"KeyBindings");var Z=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}canExecuteCommand(e,...n){return this.commands[e]?!(this.commands[e].when&&!this.commands[e].when(...n)):!1}executeCommand(e,...n){return new Promise(t=>{let o=this.commands[e].action(...n);t(o)})}};a(Z,"CommandRegistry");var ee=class{constructor(){this.menus={}}registerMenu(e,n){this.menus[e]=n}};a(ee,"MenuRegistry");function we(r,e,n,t){return n?e.disabled||!r.canExecuteCommand(n.id,t):e.disabled}a(we,"isDisabled");var ve={view({attrs:{workbench:r,x:e,y:n,items:t,align:o,commands:i,ctx:s}}){let d=a((l,u)=>f=>{f.stopPropagation(),!we(r,l,u,s)&&(r.closeMenu(),l.onclick&&l.onclick(),u&&r.executeCommand(u.id,s))},"onclick");return m("ul",{class:"menu",style:{margin:"0",display:"inline-block"}},t.filter(l=>!l.when||l.when()).map(l=>{let u="",f,p;return l.command&&(p=i.find(k=>k.id===l.command),f=r.keybindings.getBinding(p.id),u=p.title),l.title&&(u=l.title()),m("li",{onclick:d(l,p),class:we(r,l,p,s)?"disabled":"",style:{display:"flex"}},m("div",null,u),f&&m("div",{class:"keybindings grow text-right"},oe(f.key).join(" ").toUpperCase()))}))}};var V={onupdate({state:r,dom:e}){let n=e.querySelector(".items").children;r.selected!==void 0&&n.length>0&&n[r.selected].scrollIntoView({block:"nearest"})},oncreate({attrs:r,state:e,dom:n}){r.inputview&&n.querySelector("input")?.focus(),e.selected===void 0&&(e.selected=0)},view({attrs:r,state:e}){e.selected=e.selected===void 0?0:e.selected,e.input=e.input===void 0?r.input||"":e.input,e.items===void 0&&(e.items=[],r.onchange(e));let n=a(o=>{let i=a((s,d)=>(s%d+d)%d,"mod");if(o.key==="ArrowDown")return e.selected===void 0?(e.selected=0,!1):(e.selected=i(e.selected+1,e.items.length),!1);if(o.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=i(e.selected-1,e.items.length),!1;if(o.key==="Enter")return e.selected!==void 0&&r.onpick(e.items[e.selected]),!1},"onkeydown"),t=a(o=>{e.input=o.target.value,e.selected=0,r.onchange(e)},"oninput");return m("div",{class:"picker"},r.inputview(n,t,e.input),m("div",{class:"items"},e.items.map((o,i)=>m("div",{class:e.selected===i?"item selected":"item",onclick:()=>r.onpick(o),onmouseover:()=>e.selected=i},r.itemview(o,i)))))}};var ke={view({attrs:{workbench:r,ctx:e}}){let n=Object.values(r.commands.commands),t=a(s=>{r.closeDialog(),r.commands.executeCommand(s.id,e)},"onpick"),o=a(s=>{s.items=n.filter(d=>(d.title||d.id).toLowerCase().includes(s.input.toLowerCase()))},"onchange"),i=a(s=>{let d=r.keybindings.getBinding(s.id);return d?oe(d.key).join(" ").toUpperCase():""},"getBindingSymbols");return m("div",{class:"palette"},m(V,{onpick:t,onchange:o,inputview:(s,d)=>m("div",null,m("input",{style:{width:"98%"},type:"text",onkeydown:s,oninput:d,placeholder:"Enter command..."})),itemview:s=>m("div",{class:"flex"},m("div",null,s.title||s.id),m("div",{class:"keybindings grow text-right"},i(s)))}))}};function W(r,e){return r.value&&r.value[e]instanceof Function}a(W,"hasHook");function U(r,e,...n){if(W(r,e))return r.value[e].apply(r.value,n)}a(U,"triggerHook");function O(r,e){for(let n of r.components)if(W(n,e))return!0;return!1}a(O,"objectHas");function Q(r,e,...n){for(let t of r.components)if(W(t,e))return t.value[e].apply(t.value,n)}a(Q,"objectCall");function le(r,e,...n){let t=[];for(let o of r.components)W(o,e)&&t.push(o.value);return t}a(le,"componentsWith");function j(r){return O(r,"objectChildren")}a(j,"objectManaged");var H={view({attrs:{workbench:r,path:e,onkeydown:n,oninput:t,disallowEmpty:o,editValue:i,placeholder:s},state:d}){let l=e.node,u=i?"value":"name",f=a(()=>u==="name"?O(l,"displayName")?Q(l,"displayName",l):l.name:l[u]||"","display"),p=a(()=>{d.initialValue=l[u],r.context.node=l,r.context.path=e},"onfocus"),k=a(()=>l[u],"getter"),S=a((h,w)=>{l.isDestroyed||(o&&h.length===0?l[u]=d.initialValue:l[u]=h),w&&(r.context.node=null)},"setter");l.raw.Rel==="Fields"&&(s=i?"Value":"Field");let g=`input-${e.id}-${l.id}`;return u==="value"&&(g=g+"-value"),m(Me,{id:g,getter:k,setter:S,display:f,onkeydown:n,onfocus:p,oninput:t,placeholder:s})}},Me={oncreate({dom:r,attrs:e}){let n=r.querySelector("textarea"),t=n.offsetHeight,o=r.querySelector("span");this.updateHeight=()=>{o.style.width=`${Math.max(n.offsetWidth,100)}px`,o.innerHTML=n.value.replace(`
`,"<br/>"),n.style.height=o.offsetHeight>0?`${o.offsetHeight}px`:`${t}px`},n.addEventListener("input",()=>this.updateHeight()),n.addEventListener("blur",()=>o.innerHTML=""),setTimeout(()=>this.updateHeight(),50),e.onmount&&e.onmount(n)},onupdate(){this.updateHeight()},view({attrs:{id:r,onkeydown:e,onfocus:n,onblur:t,oninput:o,getter:i,setter:s,display:d,placeholder:l},state:u}){let f=u.editing?u.buffer:d?d():i();return m("div",{class:"node-container"},m("textarea",{id:r,rows:"1",onfocus:a(h=>{n&&n(h),u.editing=!0,u.buffer=i()},"startEdit"),onblur:a(h=>{u.editing&&(u.editing=!1,s(u.buffer,!0),u.buffer=void 0),t&&t(h)},"finishEdit"),oninput:a(h=>{u.buffer=h.target.value,s(u.buffer,!1),o&&o(h)},"edit"),placeholder:l,onkeydown:e||a(h=>{h.key==="Enter"&&(h.preventDefault(),h.stopPropagation())},"defaultKeydown"),value:f},f),m("span",{style:{visibility:"hidden",position:"fixed"}}))}};var ye={view({attrs:{node:r,workbench:e,panel:n}}){return m("div",{class:"empty-view"})}};var be={view({attrs:{workbench:r,path:e}}){return m("div",{class:"new-node flex flex-row items-center"},m("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7"}),m("path",{style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{class:"flex grow"},m("input",{class:"grow",type:"text",oninput:a(o=>{r.executeCommand("insert-child",{node:e.node,path:e},o.target.value)},"startNew"),onkeydown:a(o=>{if(o.key==="Tab"&&(o.stopPropagation(),o.preventDefault(),node.childCount>0)){let i=e.node.children[e.node.childCount-1];r.executeCommand("insert-child",{node:i,path:e})}},"tabNew"),value:""})))}};var xe={view({attrs:{workbench:r,path:e,alwaysShowNew:n}}){let t=e.node;e.node.refTo&&(t=e.node.refTo);let o=!1;return(t.childCount===0&&t.getLinked("Fields").length===0||n)&&(o=!0),m("div",{class:"list-view"},m("div",{class:"fields"},t.getLinked("Fields").length>0&&t.getLinked("Fields").map(i=>m(te,{key:i.id,workbench:r,path:e.append(i)}))),m("div",{class:"children"},t.childCount>0&&t.children.map(i=>m(te,{key:i.id,workbench:r,path:e.append(i)})),o&&m(be,{workbench:r,path:e})))}};var Ce={view({attrs:{workbench:r,path:e},state:n}){let t=e.node;n.fields=n.fields===void 0?new Set:n.fields,t.children.forEach(i=>{i.getLinked("Fields").forEach(s=>n.fields.add(s.name))});let o=a((i,s)=>{let d=i.getLinked("Fields").filter(l=>l.name===s);return d.length===0?"":m(H,{editValue:!0,workbench:r,path:e.append(d[0])})},"getFieldEditor");return m("table",{class:"table-view",style:{gridTemplateColumns:`repeat(${n.fields.size+1}, 1fr)`}},m("thead",null,m("tr",null,m("th",null,"Title"),[...n.fields].map(i=>m("th",null,i)))),m("tbody",null,t.children.map(i=>m("tr",null,m("td",null,m(te,{key:i.id,workbench:r,path:e.append(i)})),[...n.fields].map(s=>m("td",null,o(i,s)))))))}};var Ne={list:xe,table:Ce};function ce(r){return Ne[r]||ye}a(ce,"getView");window.registerView=(r,e)=>{Ne[r]=e,workbench.commands.registerCommand({id:`view-${r}`,title:`View as ${Oe(r)}`,action:n=>{n.node&&n.node.setAttr("view",r)}})};function Oe(r){return r.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}a(Oe,"toTitleCase");var ue={};function B(r){ue[z(r)]=r}a(B,"component");function z(r){return r.prototype===void 0&&(r=r.constructor),`treehouse.${r.name}`}a(z,"componentName");function J(r){return typeof r=="string"?ue[r]:ue[z(r)]}a(J,"getComponent");function Ie(r,e){let n=new(J(r));return n.fromJSON instanceof Function?n.fromJSON(e):Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)),n}a(Ie,"inflateToComponent");function Se(r){if(r===void 0)return;if(!J(r))return structuredClone(r);let n=JSON.parse(JSON.stringify(r)||""),t=new r.constructor;return t.fromJSON instanceof Function?t.fromJSON(n):Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)),t}a(Se,"duplicate");var M=class{constructor(){}onAttach(e){this.object=e.parent}handleIcon(e=!1){return m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"15",height:"15",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"3","stroke-linecap":"round","stroke-linejoin":"round",class:"node-bullet"},e?m("circle",{id:"node-collapsed-handle",stroke:"none",cx:"12",cy:"12",r:"12"}):null,m("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),m("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"}))}toJSON(e){return{}}static initialize(e){e.commands.registerCommand({id:"make-template",title:"Make Template",action:n=>{if(!n.node)return;let t=new M;n.node.addComponent(t),n.node.changed()}})}static findNode(e,n){let t=null;return e.mainNode().walk(o=>o.value instanceof M&&o.value.object.name===n?(t=o.value.object,!0):!1,{includeComponents:!0}),t}};a(M,"Template"),M=P([B],M);var N=class{constructor(e){this.name=e}afterEditor(){return He}static initialize(e){e.commands.registerCommand({id:"add-tag",title:"Add tag",action:(n,t)=>{if(!n.node)return;let o=new N(t);n.node.addComponent(o);let i=M.findNode(e.workspace,t);i&&(i.fields.map(s=>s.duplicate()).forEach(s=>{n.node.addLinked("Fields",s),s.raw.Parent=n.node.raw.ID}),i.children.map(s=>s.duplicate()).forEach(s=>{n.node.addChild(s),s.raw.Parent=n.node.raw.ID})),n.node.changed()}})}static findAll(e){let n=new Set;return e.mainNode().walk(t=>(t.value instanceof N&&n.add(t.value.name),!1),{includeComponents:!0}),[...n]}static findTagged(e,n){let t=[];return e.mainNode().walk(o=>(o.value instanceof N&&o.value.name===n&&t.push(o.parent),!1),{includeComponents:!0}),t}static showPopover(e,n,t,o,i){let s=N.findAll(e.workspace),d=e.getInput(n),l=d.getBoundingClientRect(),u=document.body.scrollLeft+l.x+d.selectionStart*10+20,f=document.body.scrollTop+l.y+l.height;e.showPopover(()=>m(V,{onpick:p=>{i(),e.getInput(n).blur(),t.name=t.name.replace(/\s*#\w*/,""),e.executeCommand("add-tag",{node:t,path:n},p.name)},onchange:p=>{t.name.includes("#")?p.input=t.name.split("#")[1]:p.input="";let k=[...s].filter(S=>S.toLowerCase().startsWith(p.input.toLowerCase())).map(S=>({name:S}));(k[0]&&k[0].name!=p.input&&p.input!=""||k.length===0)&&k.unshift({name:p.input,prefix:"Create tag: "}),p.items=k},inputview:o,itemview:p=>m("div",{class:"flex"},m("div",null,p.prefix||"",p.name))}),{top:`${f}px`,left:`${u}px`})}};a(N,"Tag"),N=P([B],N);var He={view({attrs:{node:r,component:e}}){return m("div",{tabindex:"1",class:"badge flex flex-row items-center",onkeydown:a(t=>{t.key==="Backspace"&&(r.removeComponent(e),r.changed())},"onkeydown")},m("span",null,"#\xA0"),m("div",{style:{whiteSpace:"nowrap"}},e.name))}};var ie={view({attrs:{workbench:r,path:e,alwaysShowNew:n}}){return m(ce(e.node.getAttr("view")||"list"),{workbench:r,path:e,alwaysShowNew:n})}},te={view({attrs:r,state:e,children:n}){let{path:t,workbench:o}=r,i=t.node,s=!1,d=i;i.refTo&&(s=!0,i=d.refTo);let l=o.workspace.getExpanded(t.head,d),u=O(i,"handlePlaceholder")?Q(i,"handlePlaceholder"):"",f=a(c=>{e.hover=!0,c.stopPropagation()},"hover"),p=a(c=>{e.hover=!1,c.stopPropagation()},"unhover"),k=a(c=>{l?o.executeCommand("collapse",{node:d,path:t}):o.executeCommand("expand",{node:d,path:t}),c.stopPropagation()},"toggle"),S=a(()=>{e.tagPopover&&(o.closePopover(),e.tagPopover=void 0)},"cancelTagPopover"),g=a(c=>{e.tagPopover?(e.tagPopover.oninput(c),c.target.value.includes("#")||S()):c.target.value.includes("#")&&(e.tagPopover={},N.showPopover(o,t,i,(R,b)=>{e.tagPopover={onkeydown:R,oninput:b}},S))},"oninput"),h=a(c=>{if(e.tagPopover){if(c.key==="Escape"){S();return}if(e.tagPopover.onkeydown(c)===!1)return c.stopPropagation(),!1}let R=c.shiftKey||c.metaKey||c.altKey||c.ctrlKey;switch(c.key){case"ArrowUp":c.target.selectionStart!==0&&!R&&c.stopPropagation();break;case"ArrowDown":c.target.selectionStart!==c.target.value.length&&c.target.selectionStart!==0&&!R&&c.stopPropagation();break;case"Backspace":if(c.target.value===""){if(c.preventDefault(),c.stopPropagation(),i.childCount>0)return;o.executeCommand("delete",{node:i,path:t,event:c});return}if(c.target.value!==""&&c.target.selectionStart===0&&c.target.selectionEnd===0){if(c.preventDefault(),c.stopPropagation(),i.childCount>0)return;let b=o.workspace.findAbove(t);if(!b)return;let D=b.node.name;b.node.name=D+c.target.value,i.destroy(),m.redraw.sync(),o.focus(b,D.length);return}break;case"Enter":if(c.preventDefault(),c.ctrlKey||c.shiftKey||c.metaKey||c.altKey)return;if(c.target.selectionStart===c.target.value.length){i.childCount>0&&o.workspace.getExpanded(t.head,i)?o.executeCommand("insert-child",{node:i,path:t},"",0):o.executeCommand("insert",{node:i,path:t}),c.stopPropagation();return}if(c.target.selectionStart===0){o.executeCommand("insert-before",{node:i,path:t}),c.stopPropagation();return}if(c.target.selectionStart>0&&c.target.selectionStart<c.target.value.length){o.executeCommand("insert",{node:i,path:t},c.target.value.slice(c.target.selectionStart)).then(()=>{i.name=c.target.value.slice(0,c.target.selectionStart)}),c.stopPropagation();return}break}},"onkeydown"),w=a(c=>{c.preventDefault(),c.stopPropagation(),o.executeCommand("open",{node:i,path:t}),document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()},"open"),y=a(c=>c.childCount+c.getLinked("Fields").length,"subCount"),T=a(()=>{if(i.id===o.context?.node?.id||e.hover||i.name.length>0||u.length>0)return!0},"showHandle");return m("div",{onmouseover:f,onmouseout:p},m("div",{class:"node-row-outer-wrapper flex flex-row items-start"},m("svg",{class:"node-menu shrink-0",xmlns:"http://www.w3.org/2000/svg",onclick:c=>o.showMenu(c,{node:d,path:t}),oncontextmenu:c=>o.showMenu(c,{node:d,path:t}),"data-menu":"node",viewBox:"0 0 16 16"},e.hover&&m("path",{style:{transform:"translateY(-1px)"},fill:"currentColor","fill-rule":"evenodd",d:"M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"})),m("div",{class:"node-handle shrink-0",onclick:k,ondblclick:w,oncontextmenu:c=>o.showMenu(c,{node:d,path:t}),"data-menu":"node",style:{display:T()?"block":"none"}},O(i,"handleIcon")?Q(i,"handleIcon",y(i)>0&&!l):m("svg",{class:"node-bullet",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg"},y(i)>0&&!l?m("circle",{id:"node-collapsed-handle",cx:"8",cy:"8",r:"8"}):null,m("circle",{cx:"8",cy:"8",r:"3",fill:"currentColor"}),",",s?m("circle",{id:"node-reference-handle",cx:"8",cy:"8",r:"7",fill:"none","stroke-width":"1",stroke:"currentColor","stroke-dasharray":"3,3"}):null)),i.raw.Rel==="Fields"?m("div",{class:"flex grow items-start flex-row"},m("div",null,m(H,{workbench:o,path:t,onkeydown:h,oninput:g})),m(H,{editValue:!0,workbench:o,path:t,onkeydown:h,oninput:g})):m("div",{class:"flex grow items-start flex-row",style:{gap:"0.5rem"}},O(i,"beforeEditor")&&le(i,"beforeEditor").map(c=>m(c.beforeEditor(),{node:i,component:c})),m(H,{workbench:o,path:t,onkeydown:h,oninput:g,placeholder:u}),O(i,"afterEditor")&&le(i,"afterEditor").map(c=>m(c.afterEditor(),{node:i,component:c})))),O(i,"belowEditor")&&m(Q(i,"belowEditor"),{node:i}),l===!0&&m("div",{class:"expanded-node flex flex-row"},m("div",{class:"indent flex",onclick:k}),m("div",{class:"view grow"},m(ce(i.getAttr("view")||"list"),{workbench:o,path:t}))))}};var De={view({attrs:{workbench:r,node:e}}){let n=new F(e,"quickadd");return m("div",{class:"notice"},m("h3",null,"Quick Add"),m(ie,{workbench:r,path:n,alwaysShowNew:!0}),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{r.commitQuickAdd(),r.closeDialog()}},"Add to Today")))}};var Le={view({attrs:{workbench:r}}){let e=r.workspace.settings.theme;return m("div",{class:"notice"},m("form",{method:"dialog"},m("h3",null,"Settings"),m("div",{class:"flex flex-row"},m("div",{class:"grow"},"Theme"),m("div",null,m("select",{name:"theme"},m("option",{selected:e==="",value:""},"Light"),m("option",{selected:e==="darkmode",value:"darkmode"},"Dark"),m("option",{selected:e==="sepia",value:"sepia"},"Sepia"),m("option",{selected:e==="sublime",value:"sublime"},"Sublime")))),m("div",{class:"button-bar"},m("button",{onclick:()=>{r.closeDialog()}},"Cancel"),m("button",{class:"primary",onclick:async n=>{let t=n.target.closest("form").elements[0].value;e!==t?(r.workspace.settings.theme=t,await r.workspace.save(!0),location.reload()):r.closeDialog()}},"Save Changes"))))}};var Ee={view(){return m("div",{class:"notice"},m("h3",null,"Refresh to view latest updates"),m("p",null,"Your notes were updated in another browser session. Refresh the page to view the latest version."),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{location.reload()}},"Refresh Now")))}},Ae={view({attrs:{workbench:r}}){return m("div",{class:"notice"},m("h3",null,"Treehouse is under active development"),m("p",null,"This is a preview based on our main branch, which is actively being developed."),m("p",null,"If you find a bug, please report it via [ ",m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{display:"inline",marginLeft:"0.25rem",marginRight:"0.25rem"},width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"}))," > Submit Issue ]."),m("p",null,"Data is stored using localstorage, which you can reset via [ ",m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{display:"inline",marginLeft:"0.25rem",marginRight:"0.25rem"},width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"}))," > Reset Demo ]."),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{localStorage.setItem("firsttime","1"),r.closeDialog()}},"Got it")))}},Pe={view({attrs:{workbench:r,finished:e}}){return m("div",{class:"notice"},m("h3",null,"Login with GitHub"),m("p",null,"The GitHub backend is experimental so use at your own risk!"),m("p",null,"To store your workbench we will create a public repository called ",m("pre",{style:{display:"inline"}},"<username>.treehouse.sh")," if it doesn't already exist. You can manually make this repository private via GitHub if you want."),m("p",null,"You can Logout via the",m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{display:"inline",marginLeft:"0.5rem",marginRight:"0.5rem"},width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"})),"menu in the top right to return to the localstorage backend."),m("div",{class:"button-bar"},m("button",{onclick:()=>{r.closeDialog()}},"Cancel"),m("button",{class:"primary",onclick:()=>{r.closeDialog(),localStorage.setItem("github","1"),e()}},"Log in with GitHub")))}};var K=class{constructor(e){this.commands=new Z,this.keybindings=new X,this.menus=new ee,this.backend=e,this.workspace=new Y(e.files),this.context={node:null},this.panels=[],this.dialog={body:()=>null},this.menu={body:()=>null}}get mainPanel(){return this.panels[0]}async initialize(){if(await this.workspace.load(),this.workspace.rawNodes.forEach(e=>this.backend.index.index(e)),this.workspace.observe(e=>{this.workspace.save(),e.isDestroyed?this.backend.index.remove(e.id):(this.backend.index.index(e.raw),e.components.forEach(n=>this.backend.index.index(n.raw)))}),this.workspace.lastOpenedID?this.openNewPanel(this.workspace.find(this.workspace.lastOpenedID)||this.workspace.mainNode()):this.openNewPanel(this.workspace.mainNode()),this.backend.loadExtensions&&await this.backend.loadExtensions(),this.workspace.settings.theme){let e=document.createElement("link");e.setAttribute("href",`https://treehouse.sh/style/themes/${this.workspace.settings.theme}.css`),e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),document.head.appendChild(e)}m.redraw()}authenticated(){return this.backend.auth&&this.backend.auth.currentUser()}openQuickAdd(){let e=this.workspace.find("@quickadd");e||(e=this.workspace.new("@quickadd")),this.showDialog(()=>m(De,{workbench:this,node:e}),!0),setTimeout(()=>{document.querySelector("main > dialog .new-node input").focus()},1)}commitQuickAdd(){let e=this.workspace.find("@quickadd");if(!e)return;let n=this.todayNode();e.children.forEach(t=>t.parent=n)}clearQuickAdd(){let e=this.workspace.find("@quickadd");e&&e.children.forEach(n=>n.destroy())}todayNode(){let e=new Date,n=e.toUTCString().split(e.getFullYear())[0],t=`Week ${String($e(e)).padStart(2,"0")}`,i=["@calendar",`${e.getFullYear()}`,t,n].join("/"),s=this.workspace.find(i);return s||(s=this.workspace.new(i)),s}openToday(){this.open(this.todayNode())}open(e){this.workspace.expanded[e.id]||(this.workspace.expanded[e.id]={}),this.workspace.lastOpenedID=e.id,this.workspace.save();let n=new F(e);this.panels[0]=n,this.context.path=n}openNewPanel(e){this.workspace.expanded[e.id]||(this.workspace.expanded[e.id]={}),this.workspace.lastOpenedID=e.id,this.workspace.save();let n=new F(e);this.panels.push(n),this.context.path=n}closePanel(e){this.panels=this.panels.filter(n=>n.name!==e.name)}defocus(){this.context.node=null}focus(e,n=0){let t=this.getInput(e);t?(this.context.path=e,t.focus(),n!==void 0&&t.setSelectionRange(n,n)):console.warn("unable to find input for",e)}getInput(e){let n=`input-${e.id}-${e.node.id}`;return e.node.raw.Rel==="Fields"&&e.node.name!==""&&(n=n+"-value"),document.getElementById(n)}canExecuteCommand(e,n,...t){return n=this.newContext(n),this.commands.canExecuteCommand(e,n,...t)}executeCommand(e,n,...t){return n=this.newContext(n),console.log(e,n,...t),this.commands.executeCommand(e,n,...t)}newContext(e){return Object.assign({},this.context,e)}showMenu(e,n,t){e.stopPropagation(),e.preventDefault();let o=e.target.closest("*[data-menu]"),i=o.getBoundingClientRect();if(!t){let l=o.dataset.align||"left";t={top:`${document.body.scrollTop+i.y+i.height}px`},l==="right"?(t.marginLeft="auto",t.marginRight=`${document.body.offsetWidth-i.right}px`):(t.marginLeft=`${document.body.scrollLeft+i.x}px`,t.marginRight="auto")}let s=this.menus.menus[o.dataset.menu],d=s.filter(l=>l.command).map(l=>this.commands.commands[l.command]);s&&(this.menu={body:()=>m(ve,{workbench:this,ctx:this.newContext(n),items:s,commands:d}),style:t},m.redraw(),setTimeout(()=>{document.querySelector("main > dialog.menu").showModal()},0))}closeMenu(){document.querySelector("main > dialog.menu").close(),workbench.menu.body=()=>null}showPalette(e,n,t){this.showDialog(()=>m(ke,{workbench:this,ctx:t}),!1,{left:`${e}px`,top:`${n}px`})}showNotice(e,n){this.showDialog(()=>m({firsttime:Ae,github:Pe,lockstolen:Ee}[e],{workbench:this,finished:n}),!0,void 0,e==="lockstolen")}showSettings(){this.showDialog(()=>m(Le,{workbench:this}),!0)}showPopover(e,n){this.popover={body:e,style:n},m.redraw()}closePopover(){this.popover=null,m.redraw()}showDialog(e,n,t,o){this.dialog={body:e,backdrop:n,style:t,explicitClose:o},m.redraw(),setTimeout(()=>{document.querySelector("main > dialog.modal").showModal()},0)}isDialogOpen(){return document.querySelector("main > dialog.modal").hasAttribute("open")}closeDialog(){document.querySelector("main > dialog.modal").close(),this.dialog.body=()=>null}search(e){if(!e)return[];let n=e.split(/\s+(?=(?:[^\'"]*[\'"][^\'"]*[\'"])*[^\'"]*$)/),t=n.filter(s=>!s.includes(":")).join(" "),o=Object.fromEntries(n.filter(s=>s.includes(":")).map(s=>s.toLowerCase().split(":")));!t&&Object.keys(o).length>0&&(t=Object.keys(o)[0]);let i=a(s=>{if(Object.keys(o).length>0){let d={};for(let l of s.getLinked("Fields"))d[l.name.toLowerCase()]=l.value.toLowerCase();for(let l in o)if(!d[l]||d[l]!==o[l].replace(/['"]/g,""))return!1}return!0},"passFieldQuery");return t.startsWith("#")?N.findTagged(this.workspace,t.replace("#","")).filter(i):this.backend.index.search(t).map(s=>{let d=window.workbench.workspace.find(s);if(d&&!(d.value&&(d=d.parent,!d.raw))&&i(d))return d}).filter(s=>s!==void 0)}};a(K,"Workbench");function $e(r){var e=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())),n=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-n);var t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}a($e,"getWeekOfYear");function Be(r){function e(D,x){var C=D<<x|D>>>32-x;return C}a(e,"rotate_left");function n(D){var x="",C,L,pe;for(C=0;C<=6;C+=2)L=D>>>C*4+4&15,pe=D>>>C*4&15,x+=L.toString(16)+pe.toString(16);return x}a(n,"lsb_hex");function t(D){var x="",C,L;for(C=7;C>=0;C--)L=D>>>C*4&15,x+=L.toString(16);return x}a(t,"cvt_hex");function o(D){D=D.replace(/\r\n/g,`
`);for(var x="",C=0;C<D.length;C++){var L=D.charCodeAt(C);L<128?x+=String.fromCharCode(L):L>127&&L<2048?(x+=String.fromCharCode(L>>6|192),x+=String.fromCharCode(L&63|128)):(x+=String.fromCharCode(L>>12|224),x+=String.fromCharCode(L>>6&63|128),x+=String.fromCharCode(L&63|128))}return x}a(o,"Utf8Encode");var i,s,d,l=new Array(80),u=1732584193,f=4023233417,p=2562383102,k=271733878,S=3285377520,g,h,w,y,T,b;r=o(r);var c=r.length,R=new Array;for(s=0;s<c-3;s+=4)d=r.charCodeAt(s)<<24|r.charCodeAt(s+1)<<16|r.charCodeAt(s+2)<<8|r.charCodeAt(s+3),R.push(d);switch(c%4){case 0:s=2147483648;break;case 1:s=r.charCodeAt(c-1)<<24|8388608;break;case 2:s=r.charCodeAt(c-2)<<24|r.charCodeAt(c-1)<<16|32768;break;case 3:s=r.charCodeAt(c-3)<<24|r.charCodeAt(c-2)<<16|r.charCodeAt(c-1)<<8|128;break}for(R.push(s);R.length%16!=14;)R.push(0);for(R.push(c>>>29),R.push(c<<3&4294967295),i=0;i<R.length;i+=16){for(s=0;s<16;s++)l[s]=R[i+s];for(s=16;s<=79;s++)l[s]=e(l[s-3]^l[s-8]^l[s-14]^l[s-16],1);for(g=u,h=f,w=p,y=k,T=S,s=0;s<=19;s++)b=e(g,5)+(h&w|~h&y)+T+l[s]+1518500249&4294967295,T=y,y=w,w=e(h,30),h=g,g=b;for(s=20;s<=39;s++)b=e(g,5)+(h^w^y)+T+l[s]+1859775393&4294967295,T=y,y=w,w=e(h,30),h=g,g=b;for(s=40;s<=59;s++)b=e(g,5)+(h&w|h&y|w&y)+T+l[s]+2400959708&4294967295,T=y,y=w,w=e(h,30),h=g,g=b;for(s=60;s<=79;s++)b=e(g,5)+(h^w^y)+T+l[s]+3395469782&4294967295,T=y,y=w,w=e(h,30),h=g,g=b;u=u+g&4294967295,f=f+h&4294967295,p=p+w&4294967295,k=k+y&4294967295,S=S+T&4294967295}var b=t(u)+t(f)+t(p)+t(k)+t(S);return b.toLowerCase()}a(Be,"SHA1");var F=class{constructor(e,n){n?this.name=n:this.name=Math.random().toString(36).substring(2),e?this.nodes=[e]:this.nodes=[]}push(e){this.nodes.push(e)}pop(){return this.nodes.pop()||null}sub(){return new F(this.node,this.name)}clone(){let e=new F;return e.name=this.name,e.nodes=[...this.nodes],e}append(e){let n=this.clone();return n.push(e),n}get length(){return this.nodes.length}get id(){return Be([this.name,...this.nodes.map(e=>e.id)].join(":"))}get node(){return this.nodes[this.nodes.length-1]}get previous(){return this.nodes.length<2?null:this.nodes[this.nodes.length-2]}get head(){return this.nodes[0]}};a(F,"Path");var G=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}changed(e){this.observers.forEach(n=>n(e))}import(e){for(let n of e)n.Value&&J(n.Name)&&(n.Value=Ie(n.Name,n.Value),n.Rel="Components"),this.nodes[n.ID]=n;for(let n of e){if(n.Parent==="@tmp"){delete this.nodes[n.ID];continue}if(!n.ID.startsWith("@")&&n.Parent===void 0){delete this.nodes[n.ID];continue}if(n.Parent&&!this.nodes[n.Parent]){delete this.nodes[n.ID];continue}let t=this.find(n.ID);if(t){if(t.parent&&!t.parent.raw){delete this.nodes[n.ID];continue}U(t,"onAttach",t)}}}export(){let e=[];for(let n of Object.values(this.nodes))e.push(n);return e}make(e,n){let t=null;if(e.includes("/")){let s=e.split("/");t=this.find(s[0]);for(let d=1;d<s.length-1;d++){if(t===null)throw"unable to get root";let l=t.find(s[d]);l||(l=this.make(s.slice(0,d+1).join("/"))),t=l}e=s[s.length-1]}let o=e.startsWith("@")?e:We();this.nodes[o]={ID:o,Name:e,Value:n,Linked:{Children:[],Components:[]},Attrs:{}};let i=new I(this,o);return t&&(i.parent=t),i}destroy(e){let n=e.parent;if(n!==null&&!n.isDestroyed){let t=e.raw.Rel||"Children";n.raw.Linked[t].includes(e.id)&&n.raw.Linked[t].splice(e.siblingIndex,1)}delete this.nodes[e.id],n&&this.changed(n)}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new I(this,e.ID))}root(e){e=e||"@root";let n=this.roots().find(t=>t.name===e);return n===void 0?null:n}find(e){let n=this.nodes[e];if(n)return new I(this,n.ID);let t=e.split("/");if(t.length===1&&t[0].startsWith("@"))return null;let o=this.root(t[0]);if(!o&&this.nodes[t[0]]&&(o=new I(this,this.nodes[t[0]].ID)),o?t.shift():o=this.root("@root"),!o)return null;let i=a((s,d)=>(s.refTo&&(s=s.refTo),s.children.find(l=>l.name===d)),"findChild");for(let s of t){let d=i(o,s);if(!d)return null;o=d}return o}walk(e,n){for(let t of this.roots())if(t.walk(e,n))return}observe(e){this.observers.push(e)}};a(G,"Bus");var We=a(()=>{let r=Date.now().toString(36),e=Math.random().toString(36).substring(2);return r+e},"uniqueId");var I=class{constructor(e,n){this._bus=e,this._id=n}[Symbol.for("Deno.customInspect")](){return`Node[${this.id}:${this.name}]`}get id(){return this._id}get bus(){return this._bus}get raw(){let e=this._bus.nodes[this.id];if(!e)throw`use of non-existent node ${this.id}`;return e}get name(){return this.refTo?this.refTo.name:this.raw.Name}set name(e){this.refTo?this.refTo.name=e:this.raw.Name=e,this.changed()}get value(){return this.refTo?this.refTo.value:this.raw.Value}set value(e){this.refTo?this.refTo.value=e:this.raw.Value=e,this.changed()}get parent(){return!this.raw.Parent||!this._bus.nodes[this.raw.Parent]?null:new I(this._bus,this.raw.Parent)}set parent(e){let n=this.parent;n!==null&&n.raw.Linked.Children.splice(this.siblingIndex,1),e!==null?(this.raw.Parent=e.id,e.raw.Linked.Children.push(this.id),U(e,"onAttach",e)):this.raw.Parent=void 0,this.changed()}get refTo(){let e=this.raw.Attrs.refTo;return!e||!this._bus.nodes[e]?null:new I(this._bus,e)}set refTo(e){if(!e){delete this.raw.Attrs.refTo,this.changed();return}this.raw.Attrs.refTo=e.id,this.changed()}get siblingIndex(){let e=this.parent;if(e===null)return 0;let n=this.raw.Rel||"Children";return e.raw.Linked[n].findIndex(t=>t===this.id)}set siblingIndex(e){let n=this.parent;if(n===null)return;let t=this.raw.Rel||"Children";n.raw.Linked[t].splice(this.siblingIndex,1),n.raw.Linked[t].splice(e,0,this.id),n.changed()}get prevSibling(){let e=this.parent;if(e===null||this.siblingIndex===0)return null;let n=this.raw.Rel||"Children";return e.getLinked(n)[this.siblingIndex-1]}get nextSibling(){let e=this.parent;if(e===null||this.siblingIndex===e.children.length-1)return null;let n=this.raw.Rel||"Children";return e.getLinked(n)[this.siblingIndex+1]}get ancestors(){let e=[],n=this.parent;for(;n!==null;)e.push(n),n=n.parent;return e}get isDestroyed(){return!this._bus.nodes.hasOwnProperty(this.id)}get path(){let e=this,n=[];for(;e;)n.unshift(e.name),e=e.parent;return n.join("/")}get children(){if(this.refTo)return this.refTo.children;let e=[];this.raw.Linked.Children&&(e=this.raw.Linked.Children.map(n=>new I(this._bus,n)));for(let n of this.components)if(W(n,"objectChildren"))return U(n,"objectChildren",this,e);return e}get childCount(){if(this.refTo)return this.refTo.childCount;for(let e of this.components)if(W(e,"objectChildren"))return U(e,"objectChildren",this,null).length;return this.raw.Linked.Children?this.raw.Linked.Children.length:0}addChild(e){if(this.refTo){this.refTo.addChild(e);return}this.raw.Linked.Children.push(e.id),this.changed()}removeChild(e){if(this.refTo){this.refTo.removeChild(e);return}let n=this.raw.Linked.Children.filter(t=>t===e.id);this.raw.Linked.Children=n,this.changed()}get fields(){return this.raw.Linked.Fields?this.raw.Linked.Fields.map(e=>new I(this._bus,e)):[]}get fieldCount(){return this.raw.Linked.Fields?this.raw.Linked.Fields.length:0}get components(){return this.raw.Linked.Components?this.raw.Linked.Components.map(e=>new I(this._bus,e)):[]}get componentCount(){return this.raw.Linked.Components?this.raw.Linked.Components.length:0}addComponent(e){let n=this.bus.make(z(e),e);n.raw.Parent=this.id,n.raw.Rel="Components",this.raw.Linked.Components.push(n.id),U(n,"onAttach",n),this.changed()}removeComponent(e){let n;e.name&&J(e)?n=this.components.filter(t=>t.name===z(e)):n=this.components.filter(t=>t.value===e),n.length>0&&n[0].destroy(),this.changed()}hasComponent(e){return this.components.filter(t=>t.name===z(e)).length>0}getComponent(e){let n=this.components.filter(t=>t.name===z(e));return n.length>0?n[0].value:null}getLinked(e){return this.raw.Linked[e]?this.raw.Linked[e].map(n=>new I(this._bus,n)):[]}addLinked(e,n){this.raw.Linked[e]||(this.raw.Linked[e]=[]),n.raw.Rel=e,this.raw.Linked[e].push(n.id),this.changed()}removeLinked(e,n){this.raw.Linked[e]||(this.raw.Linked[e]=[]);let t=this.raw.Linked[e].filter(o=>o===n.id);this.raw.Linked[e]=t,this.changed()}moveLinked(e,n,t){this.raw.Linked[e]||(this.raw.Linked[e]=[]);let o=this.raw.Linked[e].findIndex(s=>s===n.id);if(o===-1)return;let i=this.raw.Linked[e];i.splice(t,0,i.splice(o,1)[0]),this.raw.Linked[e]=i,this.changed()}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,n){this.raw.Attrs[e]=n,this.changed()}find(e){return this.bus.find([this.path,e].join("/"))}walk(e,n){if(n=n||{followRefs:!1,includeComponents:!1},e(this))return!0;let t=this.children;if(this.refTo&&n.followRefs){if(e(this.refTo))return!0;t=this.refTo.children}for(let o of t)if(o.walk(e,n))return!0;if(n.includeComponents){for(let o of this.components)if(o.walk(e,n))return!0}return!1}destroy(){if(this.isDestroyed)return;if(this.refTo){this._bus.destroy(this);return}let e=[];this.walk(n=>(e.push(n),!1),{followRefs:!1,includeComponents:!0}),e.reverse().forEach(n=>this._bus.destroy(n))}duplicate(){let e=this._bus.make(this.name,Se(this.value));return e.raw.Rel=this.raw.Rel,this.fields.map(n=>n.duplicate()).forEach(n=>{e.addLinked("Fields",n),n.raw.Parent=e.raw.ID}),this.components.map(n=>n.duplicate()).forEach(n=>{e.addLinked("Components",n),n.raw.Parent=e.raw.ID}),this.children.map(n=>n.duplicate()).forEach(n=>{e.addChild(n),n.raw.Parent=e.raw.ID}),e}changed(){this._bus.changed(this)}};a(I,"Node");var Y=class{constructor(e){this.fs=e,this.bus=new G,this.expanded={},this.settings={},this.writeDebounce=ze(async(n,t)=>{try{await this.fs.writeFile(n,t),console.log("Saved workspace.")}catch(o){console.error(o),document.dispatchEvent(new CustomEvent("BackendError"))}})}get rawNodes(){return this.bus.export()}observe(e){this.bus.observe(e)}async save(e){let n=JSON.stringify({version:1,lastopen:this.lastOpenedID,expanded:this.expanded,nodes:this.rawNodes,settings:this.settings},null,2);e?await this.fs.writeFile("workspace.json",n):this.writeDebounce("workspace.json",n)}async load(){let e=JSON.parse(await this.fs.readFile("workspace.json")||"{}");if(Array.isArray(e)&&(e={version:0,nodes:e}),e.nodes&&(this.bus.import(e.nodes),console.log(`Loaded ${e.nodes.length} nodes.`)),e.expanded)for(let n in e.expanded)for(let t in e.expanded[n])this.bus.find(t)&&(this.expanded[n]||(this.expanded[n]={}),this.expanded[n][t]=e.expanded[n][t]);e.lastopen&&(this.lastOpenedID=e.lastopen),e.settings&&(this.settings=Object.assign(this.settings,e.settings))}mainNode(){let e=this.bus.find("@workspace");if(!e){console.info("Building missing workspace node.");let n=this.bus.find("@root"),t=this.bus.make("@workspace");t.name="Workspace",t.parent=n;let o=this.bus.make("@calendar");o.name="Calendar",o.parent=t;let i=this.bus.make("Home");i.parent=t,e=t}return e}find(e){return this.bus.find(e)}new(e,n){return this.bus.make(e,n)}getExpanded(e,n){this.expanded[e.id]||(this.expanded[e.id]={});let t=this.expanded[e.id][n.id];return t===void 0&&(t=!1),t}setExpanded(e,n,t){this.expanded[e.id][n.id]=t,this.save()}findAbove(e){if(e.node.id===e.head.id)return null;let n=e.clone();n.pop();let t=e.node.prevSibling;if(!t){let i=e.previous.getLinked("Fields").length;return e.node.raw.Rel!=="Fields"&&i>0?n.append(e.previous.getLinked("Fields")[i-1]):n}let o=a(i=>{if(!this.getExpanded(e.head,i.node))return i;let d=i.node.getLinked("Fields").length;if(i.node.childCount===0&&d>0){let u=i.node.getLinked("Fields")[d-1];return o(i.append(u))}let l=i.node.children[i.node.childCount-1];return o(i.append(l))},"lastSubIfExpanded");return o(n.append(t))}findBelow(e){let n=e.clone();if(this.getExpanded(e.head,e.node)&&e.node.getLinked("Fields").length>0)return n.append(e.node.getLinked("Fields")[0]);if(this.getExpanded(e.head,e.node)&&e.node.childCount>0)return n.append(e.node.children[0]);let t=a(o=>{let i=o.node.nextSibling;if(i)return o.pop(),o.append(i);let s=o.previous;return s?o.node.raw.Rel==="Fields"&&s.childCount>0?(o.pop(),o.append(s.children[0])):(o.pop(),t(o)):null},"nextSiblingOrParentNextSibling");return t(n)}};a(Y,"Workspace");function ze(r,e=3e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{r.apply(this,t)},e)}}a(ze,"debounce");var E=class{constructor(){this.markdown=""}};a(E,"Page"),E=P([B],E);var Fe={view({attrs:r}){let e=r.path,n=r.workbench,t=e.node,o=a(u=>{n.executeCommand("close-panel",{},e)},"close"),i=a(u=>{e.pop()},"goBack"),s=a(u=>{n.panels=[e],n.context.path=e},"maximize"),d=a(u=>{t.getComponent(E).markdown=u.target.value,t.changed()},"editMarkdown");function l(u=""){return 20+(u.match(/\n/g)||[]).length*20}return a(l,"calcHeight"),m("div",{class:"panel flex flex-col grow"},m("div",{class:"bar flex"},e.length>1?m("div",{class:"panel-back",style:{rightPadding:"var(--padding)"}},m("svg",{onclick:i,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{"fill-rule":"evenodd",d:"M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"}))):null,m("div",{class:"panel-back-parent grow"},t.parent&&t.parent.id!=="@root"?m("span",{style:{cursor:"pointer"},onclick:()=>n.open(t.parent)},t.parent.name):m("span",null,"\xA0")),n.panels.length>1?m("div",{class:"panel-icons flex items-center"},m("svg",{onclick:s,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-maximize-2"},m("polyline",{points:"15 3 21 3 21 9"}),m("polyline",{points:"9 21 3 21 3 15"}),m("line",{x1:"21",y1:"3",x2:"14",y2:"10"}),m("line",{x1:"3",y1:"21",x2:"10",y2:"14"})),m("svg",{onclick:o,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-x"},m("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),m("line",{x1:"6",y1:"6",x2:"18",y2:"18"}))):null),m("div",{class:"body flex flex-col"},m("div",{class:"title-node",oncontextmenu:u=>n.showMenu(u,{node:t,path:e}),"data-menu":"node"},m(H,{workbench:n,path:e,disallowEmpty:!0})),t.hasComponent(E)?m("textarea",{oninput:d,value:t.getComponent(E).markdown,placeholder:"Enter Markdown text here",style:{marginLeft:"var(--padding)",padding:"var(--padding)",outline:"0",height:`${l(t.getComponent(E).markdown)}px`,border:"0"}},t.getComponent(E).markdown):null,m(ie,{workbench:n,path:e.sub(),alwaysShowNew:!0})))}};var he={view({attrs:{input:r,workbench:e}}){return m("div",{class:"search"},m(V,{onpick:a(o=>{e.closeDialog(),e.open(o)},"onpick"),onchange:a(o=>{o.input?o.items=e.search(o.input):o.items=[]},"onchange"),input:r,inputview:(o,i,s)=>m("div",{class:"flex items-center"},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0 items-center"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})),m("input",{type:"text",placeholder:"Search",value:s,onkeydown:o,oninput:i})),itemview:o=>m("div",null,o.name)}))}};var Re={view({attrs:{workbench:r},state:e}){e.open=e.open===void 0?!0:e.open;let n=a(t=>{e.open?e.open=!1:e.open=!0},"toggle");return m("main",{class:"workbench m-0 flex flex-row absolute inset-0",style:{overflow:"none"}},m("div",{class:"sidebar flex flex-col",style:{width:e.open?"256px":"52px"}},m("div",{class:"sidebar-top",style:{height:"56px"}},m("div",{class:"logo"})),m("div",{class:"grow sidebar-main"},e.open&&r.workspace.bus.root().children.map(t=>m(Te,{node:t,expanded:!0,level:0,workbench:r}))),m("div",{class:"sidebar-bottom"},m("svg",{onclick:n,xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-sidebar"},m("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"9",y1:"3",x2:"9",y2:"21"})))),m("div",{class:"main flex flex-col grow"},m("div",{class:"topbar flex"},m("div",{class:"topbar-item",onclick:()=>r.openToday(),style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-calendar"},m("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),m("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),m("line",{x1:"3",y1:"10",x2:"21",y2:"10"})),m("div",null,"Today")),m("div",{class:"topbar-item",onclick:()=>r.openQuickAdd(),style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{style:{marginRight:"var(--1)"},xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-plus-circle"},m("circle",{cx:"12",cy:"12",r:"10"}),m("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),m("line",{x1:"8",y1:"12",x2:"16",y2:"12"})),m("div",null,"Quick Add")),m("div",{class:"searchbar flex grow"},m("div",null,m("div",{class:"flex",style:{margin:"1px"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})),m("input",{type:"text",placeholder:"Search",onkeydown:t=>{if(t.key==="Control"||t.key==="Alt"||t.key==="Shift"||t.key==="Meta")return;let o=t.target.getBoundingClientRect();r.showDialog(()=>m(he,{workbench:r,input:t.key}),!1,{left:`${o.left-33}px`,top:`${o.top-9}px`,width:`${o.width+33}px`}),t.preventDefault()},style:{border:"0",outline:"0",background:"transparent",paddingTop:"3px"}})))),m("div",{onclick:t=>r.showMenu(t),"data-menu":"settings","data-align":"right",style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"})))),m("div",{class:"panels flex flex-row grow",style:{position:"relative",overflow:"hidden"}},r.panels.map(t=>m("div",null,m(Fe,{workbench:r,path:t})))),m("div",{class:"mobile-nav flex-row"},m("div",null,m("svg",{onclick:()=>{let t=document.querySelector(".sidebar").style;t.display!=="flex"?t.display="flex":t.display="none"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-sidebar"},m("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"9",y1:"3",x2:"9",y2:"21"}))),m("div",{onclick:()=>r.openToday()},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-calendar"},m("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),m("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),m("line",{x1:"3",y1:"10",x2:"21",y2:"10"}))),m("div",{onclick:()=>r.openQuickAdd()},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-plus-circle"},m("circle",{cx:"12",cy:"12",r:"10"}),m("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),m("line",{x1:"8",y1:"12",x2:"16",y2:"12"}))),m("div",{onclick:()=>r.showDialog(()=>m(he,{workbench:r}),!0,{top:"25%",bottom:"100px"})},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}))),m("div",{onclick:t=>r.showMenu(t,void 0,{bottom:"100px",marginTop:"auto"}),"data-menu":"settings"},m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"}))))),r.popover&&m("div",{class:"popover",style:{position:"absolute",...r.popover.style}},r.popover.body()),m("dialog",{class:r.dialog.backdrop?"popover modal backdrop":"popover modal",style:r.dialog.style?{margin:"0",...r.dialog.style}:{top:"-50%"},oncancel:t=>{if(r.dialog.explicitClose===!0){t.preventDefault();return}r.dialog.body=()=>null},onclick:t=>{let i=t.target.closest("dialog").getBoundingClientRect();r.dialog.explicitClose!==!0&&(t.clientX<i.left||t.clientX>i.right||t.clientY<i.top||t.clientY>i.bottom)&&r.closeDialog()}},r.dialog.body()),m("dialog",{class:"menu popover",style:{margin:"0",...r.menu.style},oncancel:t=>{r.menu.body=()=>null},onclick:t=>{let i=t.target.closest("dialog").getBoundingClientRect();(t.clientX<i.left||t.clientX>i.right||t.clientY<i.top||t.clientY>i.bottom)&&r.closeMenu()}},r.menu.body()))}},Te={view({attrs:{node:r,workbench:e,expanded:n,level:t},state:o}){o.expanded=o.expanded===void 0?n:o.expanded;let i=r.childCount>0&&t<3,s=a(l=>{i&&(o.expanded?o.expanded=!1:o.expanded=!0,l.stopPropagation())},"toggle"),d=a(l=>{document.querySelector(".mobile-nav").offsetHeight&&(document.querySelector(".sidebar").style.display="none"),e.open(r)},"open");return m("div",null,m("div",{class:"sidebar-item flex"},m("svg",{onclick:s,class:"feather feather-chevron-right shrink-0",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",xmlns:"http://www.w3.org/2000/svg"},i?o.expanded?m("polyline",{points:"6 9 12 15 18 9"}):m("polyline",{points:"9 18 15 12 9 6"}):null),m("div",{class:"sidebar-item-label grow",onclick:d,style:{cursor:"pointer",maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.name)),o.expanded&&m("div",{class:"sidebar-item-nested"},r.children.filter(l=>l.name!=="").map(l=>m(Te,{workbench:e,node:l,level:t+1}))))}};function qe(r,e=1e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{r.apply(this,t)},e)}}a(qe,"debounce");var q=class{constructor(){this.workbench=window.workbench,this.searchDebounce=qe(this.search.bind(this))}handleIcon(e=!1){return m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",class:"node-bullet",width:"15",height:"15",fill:"none",stroke:"currentColor","stroke-width":"3","stroke-linecap":"round","stroke-linejoin":"round"},e?m("circle",{id:"node-collapsed-handle",stroke:"none",cx:"12",cy:"12",r:"12"}):null,m("svg",{xmlns:"http://www.w3.org/2000/svg",x:"3",y:"3",width:"19",height:"19",viewBox:"0 0 24 24"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})))}handlePlaceholder(){return"Enter search value"}displayName(e){return e.name}onAttach(e){this.component=e,this.object=e.parent,e.bus.observe(n=>{e.isDestroyed||this.searchDebounce()})}search(){if(!this.object)return;let e=this.object.name,n=this.workbench.search(e).filter(t=>t.id!==this.object.id&&t.id!==this.component.id);(n.length!==this.lastResultCount||e!==this.lastQuery)&&(this.results&&this.results.forEach(t=>t.destroy()),this.results=n.map(t=>{let o=this.object.bus.make("");return o.raw.Parent="@tmp",o.refTo=t,o}),this.lastQuery=e,this.lastResultCount=n.length)}objectChildren(e,n){return this.results||this.search(),this.results}toJSON(e){return{}}fromJSON(e){}};a(q,"SearchNode"),q=P([B],q);var A=class{constructor(){this.checked=!1}beforeEditor(){return Ve}};a(A,"Checkbox"),A=P([B],A);var Ve={view({attrs:{node:r}}){return m("input",{type:"checkbox",style:{marginTop:"0.3rem"},onclick:a(n=>{let t=r.getComponent(A);t.checked=!t.checked,r.changed()},"toggleCheckbox"),checked:r.getComponent(A).checked})}};var $=class{constructor(){}handleIcon(){return m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("polyline",{points:"4 7 4 4 20 4 20 7"}),m("line",{x1:"9",y1:"20",x2:"15",y2:"20"}),m("line",{x1:"12",y1:"4",x2:"12",y2:"20"}))}};a($,"TextField"),$=P([B],$);var v=class{constructor(){this.log=[],this.showLog=!1}onAttach(e){this.component=e,this.object=e.parent}fromJSON(e){e.startedAt&&(this.startedAt=new Date(e.startedAt)),this.log=(e.log||[]).map(n=>[new Date(n[0]),new Date(n[1])]),this.showLog=e.showLog}toJSON(e){return{startedAt:this.startedAt,log:this.log,showLog:this.showLog}}localTotal(){return this.log.map(this.entryDuration).reduce((e,n)=>e+n,0)}grandTotal(){let e=this.localTotal();return this.object&&this.object.children.forEach(n=>{n.hasComponent(v)&&(e+=n.getComponent(v).grandTotal())}),e}start(){this.startedAt||(this.startedAt=new Date)}stop(){if(!this.startedAt)return;let e=new Date;(e.getTime()-this.startedAt.getTime())/1e3>=60&&this.log.push([this.startedAt,e]),this.startedAt=void 0}formatEntry(e){return e.length!==2?"":`${this.formatDate(e[0])} - ${new Intl.DateTimeFormat("en",{timeStyle:"short"}).format(e[1])}`}entryDuration(e){let n=e[0];return((e[1]||new Date).getTime()-n.getTime())/1e3}formatDate(e){return e?new Intl.DateTimeFormat("en",{dateStyle:"short",timeStyle:"short"}).format(e):""}formatDuration(e){let n=e/60,t=Math.floor(n%60);return n=n/60,`${Math.floor(n%60)}:${t.toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1})}`}afterEditor(){return Qe}belowEditor(){return Je}static initialize(e){e.commands.registerCommand({id:"stop-clock",title:"Stop clock",action:n=>{if(n.node){if(!n.node.hasComponent(v)){let t=new v;n.node.addComponent(t)}n.node.getComponent(v).stop(),n.node.changed()}}}),e.keybindings.registerBinding({command:"stop-clock",key:"meta+o"}),e.commands.registerCommand({id:"start-clock",title:"Start clock",action:n=>{if(n.node){if(!n.node.hasComponent(v)){let t=new v;n.node.addComponent(t)}n.node.getComponent(v).start(),n.node.changed()}}}),e.keybindings.registerBinding({command:"start-clock",key:"meta+i"}),e.commands.registerCommand({id:"remove-clock",title:"Remove clock",action:n=>{n.node&&n.node.removeComponent(v)}})}};a(v,"Clock"),v=P([B],v);var Qe={view({attrs:{node:r}}){let e=r.getComponent(v),n=a(()=>{e.showLog=!e.showLog,r.changed()},"toggleLog");return!e.showLog&&e.startedAt?m("div",{tabindex:"1",onclick:n,class:"badge flex flex-row items-center",style:{background:"green",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{class:"blink",style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.entryDuration([e.startedAt])))):m("div",{tabindex:"1",onclick:n,class:"badge flex flex-row items-center",style:{background:"gray",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.grandTotal())))}},Je={view({attrs:{node:r}}){let e=r.getComponent(v);if(e.showLog)return m("div",{class:"expanded-node flex flex-row"},m("div",{class:"indent flex"}),m("div",{class:"grow"},e.startedAt&&m("div",{class:"flex flex-row",style:{marginBottom:"2px"}},m("div",{class:"grow"},e.formatDate(e.startedAt)," - ..."),m("div",{class:"flex flex-row items-center",style:{background:"green",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{class:"blink",style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.entryDuration([e.startedAt]))))),e.log.toReversed().map(n=>m("div",{class:"flex flex-row",style:{marginBottom:"2px"}},m("div",{class:"grow"},e.formatEntry(n)),m("div",{class:"flex flex-row items-center",style:{background:"#aaa",lineHeight:"var(--body-line-height)",paddingLeft:"0.25rem",paddingRight:"0.25rem",borderRadius:"4px",color:"white"}},m("svg",{style:{width:"1rem",height:"1rem",marginRight:"0.25rem"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"12",cy:"12",r:"10"}),m("polyline",{points:"12 6 12 12 16 14"})),m("div",null,e.formatDuration(e.entryDuration(n))))))))}};var _=class{constructor(){this.auth=null,this.files=new se,window.MiniSearch?this.index=new ne:this.index=new re}};a(_,"BrowserBackend");var ne=class{constructor(){this.indexer=new MiniSearch({idField:"ID",fields:["ID","Name","Value","Value.markdown"],storeFields:["ID"],extractField:(e,n)=>n.split(".").reduce((t,o)=>t&&t[o],e)})}index(e){this.indexer.has(e.ID)?this.indexer.replace(e):this.indexer.add(e)}remove(e){try{this.indexer.discard(e)}catch{}}search(e){let n=this.indexer.autoSuggest(e);return n.length===0?[]:this.indexer.search(n[0].suggestion,{prefix:!0,combineWith:"AND"}).map(t=>t.ID)}};a(ne,"SearchIndex_MiniSearch");var re=class{constructor(){this.nodes={}}index(e){this.nodes[e.ID]=e.Name}remove(e){delete this.nodes[e]}search(e){let n=[];for(let t in this.nodes)this.nodes[t].includes(e)&&n.push(t);return n}};a(re,"SearchIndex_Dumb");var se=class{async readFile(e){return localStorage.getItem(`treehouse:${e}`)}async writeFile(e,n){localStorage.setItem(`treehouse:${e}`,n)}};a(se,"FileStore");import{encode as Ke,decode as Ye}from"https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.mjs";var ae=class{constructor(e,n,t){this.loginURL=e,this.clientFactory=n,this.auth=this,this.shas={},this.opts=Object.assign({domain:"treehouse.sh",checkDomain:!1,privateRepo:!1},t||{});let o=new _;this.index=o.index,this.files=o.files}get repo(){return`${this.user?.userID()}.${this.opts.domain}`}async initialize(){let e=new URL(location.href).searchParams.get("code");if(e)try{let i=location.search.replace(/\bcode=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${i}`);let d=await(await fetch(this.loginURL,{method:"POST",mode:"cors",headers:{"content-type":"application/json"},body:JSON.stringify({code:e})})).json();if(d.error)throw d.error;localStorage.setItem("treehouse:gh-token",d.token)}catch(i){this.reset(),console.error(i);return}let n=new URL(location.href).searchParams.get("access_token");if(n)try{let i=location.search.replace(/\baccess_token=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${i}`),localStorage.setItem("treehouse:gh-token",n)}catch(i){this.reset(),console.error(i);return}try{if(await this.authenticate(),!this.user)throw"authentication failed"}catch(i){console.error(i),this.opts.authFallbackURL&&(location.href=this.opts.authFallbackURL);return}if(this.opts.checkDomain&&this.repo!==location.hostname){location.hostname=this.repo;return}try{await this.client.rest.repos.get({owner:this.user.userID(),repo:this.repo})}catch(i){if(i.message!=="Not Found")throw i;console.log("Creating repository...");let s=await this.client.rest.repos.createForAuthenticatedUser({name:this.repo,private:this.opts.privateRepo});if(s.status!==201){console.error(s);return}}try{await this.client.rest.repos.getContent({owner:this.user.userID(),repo:this.repo,path:"workspace.json"})}catch(i){if(i.name!=="HttpError")throw i;console.log("Creating workspace.json...");let s=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user.userID(),repo:this.repo,path:"workspace.json",message:"initial commit",content:btoa(JSON.stringify([]))});if(s.status!==201){console.error(s);return}}this.files=this;let t=Ge();await this.readFile("treehouse.lock"),await this.writeFile("treehouse.lock",t);let o=setInterval(async()=>{await this.readFile("treehouse.lock")!==t&&(clearInterval(o),document.dispatchEvent(new CustomEvent("BackendError")),console.warn("lock stolen!"))},5e3)}async loadExtensions(){try{if((await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:"",random:Math.random().toString(36).substring(2)})).data.find(n=>n.type==="dir"&&n.name==="ext")){let n=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:"ext",random:Math.random().toString(36).substring(2)});for(let t of n.data)if(t.name.endsWith(".css")){let o=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:t.path,random:Math.random().toString(36).substring(2)}),i=document.createElement("link");i.setAttribute("href",`data:text/css;charset=utf-8;base64,${o.data.content}`),i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),document.head.appendChild(i)}else if(t.name.endsWith(".js")){let o=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:t.path,random:Math.random().toString(36).substring(2)}),i=document.createElement("script");i.setAttribute("type","module"),i.setAttribute("src",`data:text/javascript;charset=utf-8;base64,${o.data.content}`),document.head.appendChild(i)}}}catch{}}async authenticate(){let e=localStorage.getItem("treehouse:gh-token");if(!e)return;this.client=new this.clientFactory({auth:e});let n=await this.client.rest.users.getAuthenticated();!n||n.error||(this.user=new de(n.data),m&&m.redraw())}currentUser(){return this.user}login(){location.assign(this.loginURL)}reset(){localStorage.removeItem("treehouse:gh-token"),this.user=null,m&&m.redraw()}logout(){this.reset(),location.reload()}async readFile(e){try{let n=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:e,random:Math.random().toString(36).substring(2)});return this.shas[e]=n.data.sha,Ye(n.data.content)}catch(n){return n.name!=="HttpError"&&console.error(n),null}}async writeFile(e,n){let t=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user?.userID(),repo:this.repo,path:e,message:"autosave",content:Ke(n),sha:this.shas[e]});this.shas[e]=t.data.content.sha}};a(ae,"GitHubBackend");var de=class{constructor(e){this.user=e}userID(){return this.user.login}displayName(){return this.user.name}avatarURL(){return this.user.avatar_url}};a(de,"User");function Ge(){let r=Date.now().toString(36),e=Math.random().toString(36).substring(2);return r+e}a(Ge,"uniqueID");async function Ao(r,e,n){n.initialize&&await n.initialize();let t=new K(n);window.workbench=t,await t.initialize(),[v,$,E,A,N,M].forEach(o=>{o.initialize&&o.initialize(t)}),r.addEventListener("BackendError",()=>{t.showNotice("lockstolen",()=>{location.reload()})}),t.commands.registerCommand({id:"cut",title:"Cut",when:o=>{if(!o.node)return!1;let i=t.getInput(o.path);return i&&i.selectionStart===i.selectionEnd?!0:(t.clipboard=void 0,!1)},action:o=>{t.clipboard={op:"cut",node:o.node}}}),t.keybindings.registerBinding({command:"cut",key:"meta+x"}),t.commands.registerCommand({id:"copy",title:"Copy",when:o=>{if(!o.node)return!1;let i=t.getInput(o.path);return i&&i.selectionStart===i.selectionEnd?!0:(t.clipboard=void 0,!1)},action:o=>{t.clipboard={op:"copy",node:o.node}}}),t.keybindings.registerBinding({command:"copy",key:"meta+c"}),t.commands.registerCommand({id:"copy-reference",title:"Copy as Reference",when:o=>{if(!o.node)return!1;let i=t.getInput(o.path);return i&&i.selectionStart===i.selectionEnd?!0:(t.clipboard=void 0,!1)},action:o=>{t.clipboard={op:"copyref",node:o.node}}}),t.keybindings.registerBinding({command:"copy-reference",key:"shift+ctrl+c"}),t.commands.registerCommand({id:"paste",title:"Paste",when:o=>!!t.clipboard,action:o=>{if(!o.node||o.path.previous&&j(o.path.previous))return;switch(t.clipboard.op){case"copy":t.clipboard.node=t.clipboard.node.duplicate();break;case"copyref":let s=t.workspace.new("");s.refTo=t.clipboard.node,t.clipboard.node=s;break}t.clipboard.node.raw.Rel==="Fields"?(t.clipboard.node.raw.Parent=o.node.parent.id,o.node.parent.addLinked("Fields",t.clipboard.node)):(t.clipboard.node.parent=o.node.parent,t.clipboard.node.siblingIndex=o.node.siblingIndex),m.redraw.sync();let i=o.path.clone();i.pop(),t.focus(i.append(t.clipboard.node))}}),t.keybindings.registerBinding({command:"paste",key:"meta+v"}),t.commands.registerCommand({id:"create-search",title:"Create Search Node",action:o=>{if(!o.node||o.node.childCount>0)return;let i=new q;o.node.addComponent(i),t.workspace.setExpanded(o.path.head,o.node,!0),t.focus(o.path)}}),t.commands.registerCommand({id:"view-list",title:"View as List",action:o=>{o.node&&o.node.setAttr("view","list")}}),t.commands.registerCommand({id:"view-table",title:"View as Table",action:o=>{o.node&&(o.node.setAttr("view","table"),o.node.children.forEach(i=>{t.workspace.setExpanded(o.path.head,i,!1)}))}}),t.commands.registerCommand({id:"add-page",title:"Add page",action:o=>{if(!o.node)return;let i=new E;o.node.addComponent(i)}}),t.commands.registerCommand({id:"remove-page",title:"Remove page",action:o=>{o.node&&o.node.removeComponent(E)}}),t.commands.registerCommand({id:"add-checkbox",title:"Add checkbox",action:o=>{if(!o.node)return;let i=new A;o.node.addComponent(i)}}),t.commands.registerCommand({id:"remove-checkbox",title:"Remove checkbox",action:o=>{o.node&&o.node.removeComponent(A)}}),t.commands.registerCommand({id:"create-field",title:"Create Field",action:o=>{if(!o.node||o.node.childCount>0||o.node.componentCount>0||o.path.previous&&j(o.path.previous))return;let i=o.path.clone();i.pop();let s=t.workspace.new(o.node.name,"");s.raw.Parent=o.node.parent.id;let d=new $;s.addComponent(d),o.node.parent.addLinked("Fields",s),i.push(s),o.node.destroy(),m.redraw.sync(),t.focus(i)}}),t.commands.registerCommand({id:"mark-done",title:"Mark done",action:o=>{if(o.node)if(o.node.hasComponent(A)){let i=o.node.getComponent(A);i.checked?o.node.removeComponent(A):(i.checked=!0,o.node.changed())}else{let i=new A;o.node.addComponent(i)}}}),t.keybindings.registerBinding({command:"mark-done",key:"meta+enter"}),t.commands.registerCommand({id:"expand",title:"Expand",action:o=>{o.node&&(t.workspace.setExpanded(o.path.head,o.node,!0),m.redraw())}}),t.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"}),t.commands.registerCommand({id:"collapse",title:"Collapse",action:o=>{o.node&&(t.workspace.setExpanded(o.path.head,o.node,!1),m.redraw())}}),t.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"}),t.commands.registerCommand({id:"indent",title:"Indent",action:o=>{if(!o.node||o.node.raw.Rel==="Fields")return;let i=o.node,s=o.path.clone(),d=i.prevSibling;for(;d&&j(d);)if(d=d.prevSibling,!d)return;d!==null&&(s.pop(),s.push(d),i.parent=d,s.push(i),t.workspace.setExpanded(o.path.head,d,!0),m.redraw.sync(),t.focus(s))}}),t.keybindings.registerBinding({command:"indent",key:"tab"}),t.commands.registerCommand({id:"outdent",title:"Outdent",action:o=>{if(!o.node||o.node.raw.Rel==="Fields"||o.path.previous&&j(o.path.previous))return;let i=o.node,s=o.path.previous,d=o.path.clone();s!==null&&s.id!=="@root"&&(d.pop(),d.pop(),i.parent=s.parent,d.push(i),i.siblingIndex=s.siblingIndex+1,s.childCount===0&&s.getLinked("Fields").length===0&&t.workspace.setExpanded(o.path.head,s,!1),m.redraw.sync(),t.focus(d))}}),t.keybindings.registerBinding({command:"outdent",key:"shift+tab"}),t.commands.registerCommand({id:"move-up",title:"Move Up",action:o=>{if(!o.node)return;let i=o.node,s=i.parent;if(s!==null&&s.id!=="@root"){let d=s.childCount;if(i.siblingIndex===0){if(!s.prevSibling)return;let l=o.path.clone();l.pop(),l.pop();let u=s.prevSibling;for(;u&&j(u);)if(u=u.prevSibling,!u)return;l.push(u),l.push(i),i.parent=u,i.siblingIndex=u.childCount-1,t.workspace.setExpanded(o.path.head,u,!0),m.redraw.sync(),t.focus(l)}else{if(d===1)return;i.siblingIndex=i.siblingIndex-1,m.redraw.sync()}}}}),t.keybindings.registerBinding({command:"move-up",key:"shift+meta+arrowup"}),t.commands.registerCommand({id:"move-down",title:"Move Down",action:o=>{if(!o.node)return;let i=o.node,s=i.parent;if(s!==null&&s.id!=="@root"){let d=s.childCount;if(i.siblingIndex===d-1){if(!s.nextSibling)return;let l=o.path.clone();l.pop(),l.pop();let u=s.nextSibling;for(;u&&j(u);)if(u=u.nextSibling,!u)return;l.push(u),l.push(i),i.parent=u,i.siblingIndex=0,t.workspace.setExpanded(o.path.head,u,!0),m.redraw.sync(),t.focus(l)}else{if(d===1)return;i.siblingIndex=i.siblingIndex+1,m.redraw.sync()}}}}),t.keybindings.registerBinding({command:"move-down",key:"shift+meta+arrowdown"}),t.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(o,i="",s)=>{if(!o.node||j(o.node))return;let d=t.workspace.new(i);d.parent=o.node,s!==void 0&&(d.siblingIndex=s),t.workspace.setExpanded(o.path.head,o.node,!0),m.redraw.sync(),t.focus(o.path.append(d),i.length)}}),t.commands.registerCommand({id:"insert-before",title:"Insert Before",action:o=>{if(!o.node||o.path.previous&&j(o.path.previous))return;let i=t.workspace.new("");i.parent=o.node.parent,i.siblingIndex=o.node.siblingIndex,m.redraw.sync();let s=o.path.clone();s.pop(),t.focus(s.append(i))}}),t.commands.registerCommand({id:"insert",title:"Insert Node",action:(o,i="")=>{if(!o.node||o.path.previous&&j(o.path.previous))return;let s=t.workspace.new(i);s.parent=o.node.parent,s.siblingIndex=o.node.siblingIndex+1,m.redraw.sync();let d=o.path.clone();d.pop(),t.focus(d.append(s))}}),t.keybindings.registerBinding({command:"insert",key:"shift+enter"}),t.commands.registerCommand({id:"create-reference",title:"Create Reference",action:o=>{if(!o.node||o.path.previous&&j(o.path.previous))return;let i=t.workspace.new("");i.parent=o.node.parent,i.siblingIndex=o.node.siblingIndex+1,i.refTo=o.node,m.redraw.sync();let s=o.path.clone();s.pop(),t.focus(s.append(i))}}),t.commands.registerCommand({id:"delete",title:"Delete node",action:o=>{if(!o.node||o.node.id.startsWith("@")||o.path.previous&&j(o.path.previous))return;let i=t.workspace.findAbove(o.path);if(o.node.destroy(),m.redraw.sync(),i){let s=0;o.event&&o.event.key==="Backspace"&&(i.node.value?s=i.node.value.length:s=i.node.name.length),i.node.childCount===0&&t.workspace.setExpanded(o.path.head,i.node,!1),t.focus(i,s)}}}),t.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"}),t.commands.registerCommand({id:"prev",action:o=>{if(!o.node)return;let i=t.workspace.findAbove(o.path);i&&t.focus(i)}}),t.keybindings.registerBinding({command:"prev",key:"arrowup"}),t.commands.registerCommand({id:"next",action:o=>{if(!o.node)return;let i=t.workspace.findBelow(o.path);i&&t.focus(i)}}),t.keybindings.registerBinding({command:"next",key:"arrowdown"}),t.commands.registerCommand({id:"pick-command",action:o=>{let i=o.node,s=o.path,d=!1;i||(i=o.path.head,s=new F(o.path.head,o.path.name),d=!0);let l=t.getInput(s),u=l.getBoundingClientRect(),f=r.body.scrollLeft+u.x+l.selectionStart*10+20,p=r.body.scrollTop+u.y-8;d&&(f=r.body.scrollLeft+u.x,p=r.body.scrollTop+u.y+u.height),t.showPalette(f,p,t.newContext({node:i}))}}),t.keybindings.registerBinding({command:"pick-command",key:"meta+k"}),t.commands.registerCommand({id:"new-panel",title:"Open in New Panel",action:o=>{o.node&&(t.openNewPanel(o.node),m.redraw())}}),t.commands.registerCommand({id:"close-panel",title:"Close Panel",action:(o,i)=>{t.closePanel(i||o.path),t.context.path=t.mainPanel,m.redraw()}}),t.commands.registerCommand({id:"zoom",title:"Open",action:o=>{t.workspace.lastOpenedID=o.node.id,t.workspace.save(),t.context.path=o.path.append(o.node),t.panels[0]=t.context.path,m.redraw()}}),t.commands.registerCommand({id:"generate-random",title:"Generate Random Children",action:o=>{o.node&&[...Array(100)].forEach(()=>{let i=t.workspace.new(_e(8));i.parent=o.node})}}),t.menus.registerMenu("node",[{command:"zoom"},{command:"new-panel"},{command:"cut"},{command:"copy"},{command:"paste"},{command:"indent"},{command:"outdent"},{command:"move-up"},{command:"move-down"},{command:"delete"}]),t.menus.registerMenu("settings",[{title:()=>`${t.backend.auth?.currentUser()?.userID()} @ GitHub`,disabled:!0,when:()=>t.authenticated()},{title:()=>"Login with GitHub",when:()=>!t.authenticated(),onclick:()=>{localStorage.getItem("github")?t.backend.auth.login():t.showNotice("github",()=>{t.backend.auth.login()})}},{title:()=>"Reset Demo",when:()=>!t.authenticated(),onclick:()=>{localStorage.clear(),location.reload()}},{title:()=>"Settings",onclick:()=>t.showSettings()},{title:()=>"Documentation",onclick:()=>window.open("https://treehouse.sh/docs","_blank")},{title:()=>"Submit Issue",onclick:()=>window.open("https://github.com/treehousedev/treehouse/issues","_blank")},{title:()=>"Logout",when:()=>t.authenticated(),onclick:()=>t.backend.auth.logout()}]),r.addEventListener("keydown",o=>{let i=t.keybindings.evaluateEvent(o);if(i&&t.canExecuteCommand(i.command,t.context)){t.executeCommand(i.command,t.context),o.stopPropagation(),o.preventDefault();return}}),m.mount(e,{view:()=>m(Re,{workbench:t})})}a(Ao,"setup");function _e(r=10){let e=a((o,i)=>Math.round(Math.random()*(i-o)+o),"random"),n=a(()=>{let o=["got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];return o[e(0,o.length-1)]},"word");return a(o=>[...Array(o)].map((i,s)=>n()).join(" ").trim(),"words")(e(2,r))}a(_e,"generateName");export{_ as BrowserBackend,ae as GitHubBackend,ne as SearchIndex_MiniSearch,Ao as setup};
//# sourceMappingURL=treehouse.min.js.map
