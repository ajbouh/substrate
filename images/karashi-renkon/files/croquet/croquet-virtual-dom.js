let e=0;function newId(t){if(!t)return(++e).toString().padStart(4,"0");function hex(){let e=Math.random();return Math.floor(256*e).toString(16).padStart(2,"0")}return`${hex()}${hex()}`}class Style{constructor(){this.local=new Map,this.classes=null}setProperty(e,t){this.local.set(e,t)}removeProperty(e){this.local.delete(e)}getPropertyValue(e){return this.local.get(e)}getStyleString(){let e=[];return this.local.forEach(((t,s)=>{let i;if(s.startsWith("-cards-"))if("-cards-background-image-asset"===s){i=Croquet.Data.toId(t.handle)+"."+t.type}else"object"==typeof t&&t.constructor!==Array&&console.log("potentially dangerous value",t),i=JSON.stringify(t);else i=`${t}`;e.push(`${s}: ${i};`)})),this.classes&&e.push(this.classes),e.join("\n")}setStyleString(e){if(!e)return;let t=/^[ \t]*([^:]+)[ \t]*:[ \t]*([^{]+)[ \t]*[;][ \t]*$/,s=0,i=e.split("\n"),n=new Map;for(;;){let e=i[s],r=t.exec(e);if(!r)break;{let e=r[1],t=r[2];if(e.startsWith("-cards-"))if("-cards-background-image-asset"===e){let e=t.split(".");t={handle:Croquet.Data.fromId(e[0]),type:e[1]}}else t=JSON.parse(t);n.set(e,t),s++}}let r=i.slice(s).join("\n");0===r.trim().length&&(r=null),this.local=n,this.classes=r}setClasses(e){this.classes=e}getClasses(){return this.classes}getTransform(){let e=this.local;return e.get("-cards-direct-manipulation")?e.get("-cards-transform"):[1,0,0,1,0,0]}setTransform(e){this.local.set("-cards-transform",e)}getTransformOrigin(){let e=this.local;return e["-cards-direct-manipulation"]?e["-cards-transform-origin"]:""}setTransformOrigin(e){this.local.set("-cards-transform-origin",e)}}const t=function getIsLocal(){return!!window&&/isLocal/.exec(window.location.href)}();let s,i,n;function currentVM(e){window.CROQUETVM=e}function getElement(e){let s="string"==typeof e?e:e.elementId;if(!s)return console.error("element's id is falsy in getElement",s),null;let i=(t?n:window.CROQUETVM||window.ISLAND).get("worldModel"),r=i.objects[s];return r?i.getModel(r):null}class FutureHandler{constructor(e){this.tOffset=e||0}setup(e){let t=this.tOffset;return new Proxy(e,{get(s,i){if("function"==typeof e[i])return new Proxy(e[i],{apply(s,i,r){setTimeout((()=>{let t=window.CROQUETVM;currentVM(n),s.apply(e,r),currentVM(t)}),t)}});throw new Error("it has to be a method")}})}}class ViewDomain{constructor(){this.id="viewDomain"+newId(!0),this.subscriptions={}}addSubscription(e,t,s,i){let n=t+":"+s,r=e.id+"."+i;if(this.subscriptions[n]){if(-1!==this.subscriptions[n].indexOf(r))throw Error(`${e}.${i} already subscribed to ${s}`)}else this.subscriptions[n]=[];this.subscriptions[n].push({handler:r,view:e})}publishFromView(e,t,s){let i=n;currentVM(i),i.handleViewEventInModel(e,t,s),currentVM(null),this.handleViewEventInView(e,t,s)}handleViewEventInView(e,t,s){let i=e+":"+t;if(this.subscriptions[i])for(const{handler:e,view:t}of this.subscriptions[i]){let n=e.indexOf("."),r=e.slice(n+1);if(t)if(r.indexOf(".")<0){if("function"!=typeof t[r]){console.log(`event ${i} ${t}.${r}(): method not found`);continue}try{t[r](s)}catch(e){console.log(`event ${i} ${t}.${r}()`,e)}}else try{let e=r.split(".");t.call(e[0],e[1],s)}catch(e){console.log(`event ${i} ${t}.${r}()`,e)}else console.log(`event ${i} .${r}(): subscriber not found`)}}handleModelEvent(e,t,s){let i=e+":"+t;if(this.subscriptions[i])for(const{handler:e,view:t}of this.subscriptions[i]){let n=e.indexOf("."),r=e.slice(n+1);if(t)if(r.indexOf(".")<0){if("function"!=typeof t[r]){console.log(`event ${i} ${t}.${r}(): method not found`);continue}try{t[r](s)}catch(e){console.log(`event ${i} ${t}.${r}()`,e)}}else try{let e=r.split(".");t.call(e[0],e[1],s)}catch(e){console.log(`event ${i} ${t}.${r}()`,e)}else console.log(`event ${i} .${r}(): subscriber not found`)}}frame(e){this.rootView.update&&(this.rootView.update(e),window.requestAnimationFrame(this.frame.bind(this)))}}class VirtualMachine{constructor(){this.subscriptions={},this.modelsById={},this.modelsByName={},this.id=newId(),window.CROQUETVM=this}lookUpModel(e){return this.modelsById[e]}get(e){return this.modelsByName[e]}addSubscription(e,t,s,i){let n=t+":"+s,r=e.id+"."+i;if(this.subscriptions[n]){if(-1!==this.subscriptions[n].indexOf(r))throw Error(`${e}.${i} already subscribed to ${s}`)}else this.subscriptions[n]=[];this.subscriptions[n].push(r)}removeSubscription(e,t,s,i){const n=t+":"+s,r=e.id+"."+i,l=this.subscriptions[n];if(l){const e=l.indexOf(r);l.splice(e,1),0===l.length&&delete this.subscriptions[n]}}publishFromModel(e,t,s){this.handleModelEventInModel(e,t,s),this.handleModelEventInView(e,t,s)}publishFromView(e,t,s){currentVM(n),this.handleViewEventInModel(e,t,s),currentVM(null),this.handleViewEventInView(e,t,s)}handleViewEventInAllVMs(e,t,s){let i=n;currentVM(i),i.handleViewEventInModel(e,t,s),currentVM(this)}handleModelEventInModel(e,t,s){const i=e+":"+t;if(this.subscriptions[i])for(const e of this.subscriptions[i]){let t=e.indexOf("."),n=e.slice(0,t),r=e.slice(t+1),l=this.lookUpModel(n);if(l)if(r.indexOf(".")<0){if("function"!=typeof l[r]){console.log(`event ${i} ${l}.${r}(): method not found`);continue}try{l[r](s)}catch(e){console.log(`event ${i} ${l}.${r}()`,e)}}else try{let e=r.split(".");l.call(e[0],e[1],s)}catch(e){console.log(`event ${i} ${l}.${r}()`,e)}else console.log(`event ${i} .${r}(): subscriber not found`)}}handleViewEventInModel(e,t,s){const i=e+":"+t;this.subscriptions[i]&&this.handleModelEventInModel(e,t,s)}handleModelEventInView(e,t,s){let r=n;currentVM(null),i.handleModelEvent(e,t,s),currentVM(r)}}const r=t?class Model{static create(e){let t=new this;return t.init(e),n.modelsById[t.id]=t,window.CROQUETVM.modelsByName.modelRoot||(window.CROQUETVM.modelsByName.modelRoot=t),t}static register(e){}constructor(){this.id=newId(),this.__realm={vm:window.CROQUETVM},this.start=Date.now()}init(){}get vm(){return n}get sessionId(){return this.vm.id}destroy(){}subscribe(e,t,s){n.addSubscription(this,e,t,s)}unsubscribe(e,t,s){n.removeSubscription(this,e,t,s)}publish(e,t,s){n.publishFromModel(e,t,s)}beWellKnownAs(e){this.vm.modelsByName[e]=this}wellKnownModel(e){return this.vm.modelsByName[e]}getModel(e){return this.vm.lookUpModel(e)}future(e=0){return new FutureHandler(e).setup(this)}now(){return Date.now()-this.start}persistSession(e){console.log("persistSession",e())}}:Croquet.Model,l=t?class View{constructor(e){this.model=e,this.id=newId(!0),this.start=Date.now()}subscribe(e,t,s){i.addSubscription(this,e,t,s)}publish(e,t,s){i.publishFromView(e,t,s)}get sessionId(){return s.id}get session(){return s}get viewId(){return i.id}now(){return Date.now()-this.start}extrapolatedNow(){return Date.now()-this.start}future(e=0){return new FutureHandler(e).setup(this)}detach(){}}:Croquet.View;async function createSession(e,r,l,o){if(o||(o={}),t)return function makeController(e,t,r){let l=new VirtualMachine;window.CROQUETVM=l,n=l,currentVM(l);let o=!i;o&&(i=new ViewDomain);let h={model:null,view:null,id:l.id,persistentId:"abcdef"};s||(s=h);let a=e.create(r.options),d=new t(a);return setTimeout((()=>{window.CROQUETVM=l,l.publishFromModel(l.id,"view-join",d.viewId)}),100),h.model=a,h.view=d,o&&(i.rootView=d,i.frame.bind(i)()),Promise.resolve(h)}(r,l,o).then((e=>(e.view.synced&&setTimeout((()=>e.view.synced(!0)),0),e)));o.options&&!o.options.sessionName&&(Croquet.App.sessionURL=window.location.href,o.options.sessionName=window.location.href);let h={...o,name:e,password:o.password||"dummy",model:r,view:l};return Croquet.Session.join(h).then((e=>(s||(s=e),e)))}class Library{constructor(){this.library={}}find(e,t){if(!e)throw new Error("path has to be specified");e=e.split(".");let s=t;for(;e[0]&&e[1];){let t=e.shift();s[t]||(s[t]={}),s=s[t]}return[s,e[0]]}add(e,t){let[s,i]=this.find(e,this.library);s[i]=t}addLibrary(e,t){let s={};t.expanders&&t.expanders.forEach((e=>{s[e.name]=e.toString()})),t.functions&&t.functions.forEach((e=>{let t=`return ${e.toString()};`;s[e.name]=t})),t.classes&&t.classes.forEach((e=>{s[e.name]=e})),this.add(e,s)}has(e){return!!this.library[e]}get(e){let[t,s]=this.find(e,this.library);return t[s]}remove(e){let[t,s]=this.find(e,this.library);delete t[s]}installAsBaseLibrary(){Croquet.Constants.library=this}static getGlobalLibrary(){return Croquet.Constants.library}}function stringifyInner(e,t){if(void 0===e)return;if("number"==typeof e)return Number.isFinite(e)?`${e}`:"null";if("object"!=typeof e)return JSON.stringify(e);let s;if(Array.isArray(e)){s="[";for(let i=0;i<e.length;i++)i>0&&(s+=","),s+=stringifyInner(e[i],t)||"null";return s+"]"}if(null===e)return"null";if(t.has(e))throw new TypeError("Converting circular structure to JSON");if(t.add(e),e.constructor===window.Map){return stringifyInner({__map:!0,values:[...e]},t)}let i=Object.keys(e).sort();s="";for(let n=0;n<i.length;n++){let r=i[n],l=stringifyInner(e[r],t);l&&(""!==s&&(s+=","),s+=JSON.stringify(r)+":"+l)}return t.delete(e),"{"+s+"}"}function stringify(e){return stringifyInner(e,new Set)}function parse(e){return JSON.parse(e,((e,t)=>"object"==typeof t&&null!==t&&t.__map?new Map(t.values):t))}let o=null,h=Symbol("isProxy");function newProxy(e,t,s){return e[h]&&e._trait===s?e:new Proxy(e,{get:(t,i)=>i===h||("_target"===i?e:"_trait"===i?s:s&&s.hasOwnProperty(i)?new Proxy(s[i],{apply:function(e,t,n){return s[i].apply(t,n)}}):t[i])})}function asKey(e){return"string"==typeof e?e:e.elementId}function shortId(e){return e.indexOf("/")>=0&&(e=e.slice(e.indexOf("/")+1)),e}function removeStyle(e){let t=document.querySelector(`#style${e}`);t&&t.remove()}class ElementRef{constructor(e){this.elementId=e}asElementRef(){return this}equals(e){return e.elementId===this.elementId}asKey(){return asKey(this)}}class TopModel extends r{init(e,t){super.init(e,t),this.userManager={},this.containerExtent={width:"1024px",height:"768px"},this.subscribe(this.sessionId,"windowResized","windowResized"),this.subscribe(this.sessionId,"view-join","viewJoin"),this.subscribe(this.sessionId,"view-exit","viewExit")}viewJoin(e){this.userManager[e]=e,t&&this.publish(this.sessionId,"localUserJoin",e)}viewExit(e){delete this.userManager[e],this.publish(this.sessionId,"userList",null,!0)}windowResized(e){this.containerExtent=e,this.publish(this.sessionId,"resizeWindow")}appendChild(){console.log("noop")}stringify(e){return stringify(e)}parse(e){return parse(e)}static types(){return{Style:{cls:Style,write:e=>({local:e.local,classes:e.classes}),read:e=>{let t=new Style;return t.local=e.local,t.classes=e.classes,t}},ElementRef:{cls:ElementRef,write:e=>({elementId:e.elementId}),read:e=>new ElementRef(e.elementId)}}}}TopModel.register("TopModel");class Element extends r{init(e){super.init(),this._childNodes=[],this._parentNode=void 0,this._style=new Style,this._domId=void 0,this._classList=[],this._innerHTML=void 0,this._eventListeners=new Map,this._code=[],this._viewCode=[],this._me=new Map,this._listeners=[],this.$handlers={},this.worldState=null,this._subscriptions=new Map}static viewClass(){return ElementView}get elementId(){return this.id}future(e=0){let t=this;return this[h]&&(t=this._target),r.prototype.future.call(t,e)}asElementRef(){return new ElementRef(this.elementId)}newElementRef(e){return new ElementRef(e)}subscribe(e,t,s){const i=e+":"+t;let n,r=this._trait;if(r&&(r=r.constructor.name),n=s.indexOf(".")>=1||!r?s:`${r}.${s}`,this._subscriptions.get(i)){if(this._subscriptions.get(i)===n)return;this.unsubscribe(e,t)}this._subscriptions.set(i,n),super.subscribe(e,t,n)}evaluate(e,t,s,i){let n;if(t=t?parse(t):{},new Function(e)()(this,t,i),s){n=new Function(s)()(this,null),this.publish(this.sessionId,"addProject",this.asElementRef(),!0)}return n}beWorld(){this.isWorld=!0,this.objects={[this.elementId]:this.id},this.$dirtyElements=null,this.worldState=this,this.beWellKnownAs("worldModel"),this.subscribe(this.id,"domEvent","domEvent")}needsUpdate(){this.getWorldState().addDirtyElement(this)}addDirtyElement(e){this.$dirtyElements&&(this.$dirtyElements[e.elementId]=e.elementId)}changedElements(e){this.$dirtyElements&&!e||(this.$dirtyElements=this.objects);let t=Object.keys(this.$dirtyElements);return this.$dirtyElements={},{time:this.now(),elementIds:t}}createElement(e){"string"==typeof e&&(e=Element.knownElements[e.toLowerCase()]),e||(e=Element);let t=e.create(),s=this.worldState;return t.worldState=s,s.objects[t.elementId]=t.id,s.addDirtyElement(t),t}removeElement(e){delete this.objects[e.elementId],this.addDirtyElement(e)}insertBefore(e,t){let s=this._childNodes.slice(),i=t.asElementRef(),n=s.findIndex((e=>e.equals(i)));n<0&&(n=s.length);let r=e.asElementRef(),l=getElement(r),o=l&&l._parentNode;o?this.moveChild(o,r,n):(s.splice(n,0,r),this._childNodes=s,this.setParentOf(l,this),this.needsUpdate())}insertFirst(e){let t=e.asElementRef(),s=this._childNodes.slice(),i=getElement(t),n=i&&i._parentNode;n?this.moveChild(n,t,0):(s.unshift(t),this._childNodes=s,this.setParentOf(i,this),this.needsUpdate())}appendChild(e){let t=e.asElementRef(),s=this._childNodes.slice(),i=getElement(t),n=i&&i._parentNode;n?this.moveChild(n,t,s.length):(s.push(t),this._childNodes=s,this.setParentOf(i,this),this.needsUpdate())}setParentOf(e,t){let s=t?t.asElementRef():null;e._parentNode=s,this.needsUpdate()}remove(){let e=this._parentNode;e=getElement(e),e&&e.removeChild(this.asElementRef())}removeChild(e){let t=this._childNodes,s=e.asElementRef(),i=t.findIndex((e=>e.equals(s)));if(i>=0){let e=t[i],s=t.slice();s.splice(i,1),this._childNodes=s;let n=getElement(e);n&&(n.destroyAll(),this.setParentOf(n,null)),this.needsUpdate()}}moveChild(e,t,s){let i=t.asElementRef();if(this.asElementRef().equals(e)){let e=this._childNodes,t=e.findIndex((e=>e.equals(i)));if(t<0)return;if(t===s||t+1===s)return;let n=s>t+1;return e.splice(t,1),n&&s--,e.splice(s,0,i),this._childNodes=e,void this.needsUpdate()}let n=getElement(e);if(!n)return;let r=this._childNodes.slice();r.splice(s,0,t),this._childNodes=r,this.needsUpdate(),n.removeChild(t)}getParentNode(){let e=this._parentNode;return e?getElement(e):null}get parentNode(){return this.getParentNode()}getChildNodes(){return this._childNodes.map((e=>getElement(e)))}get childNodes(){return this.getChildNodes()}destroy(){this.getWorldState().removeElement(this),super.destroy()}destroyAll(){let e=this._childNodes;for(let t=0;t<e.length;t++){let s=getElement(e[t]);s&&s.destroyAll()}this.destroy()}getWorldState(){return this.worldState}getElement(e){return getElement(e)}get style(){let e=this;return{setProperty(t,s){e._style.setProperty(t,s),e.needsUpdate()},getPropertyValue:t=>e._style.getPropertyValue(t),removeProperty(t){let s=e._style.removeProperty(t);return e._style.removeProperty(t),e.needsUpdate(),s}}}get classList(){let e=this;return{add(...t){let s=e.getClassList(),i=s.slice();t.forEach((e=>{s.includes(e)||i.push(e)})),e.setClassList(i)},remove(...t){let s=e.getClassList(),i=[];s.forEach((e=>{t.includes(e)||i.push(e)})),e.setClassList(i)},replace(t,s){let i=e.getClassList().slice(),n=i.findIndex(t);n>=0&&(i[n]=s),e.setClassList(i)},contains:t=>e.getClassList().includes(t)}}setTransform(e){let t=e;"string"==typeof t&&(t=t.split(",").map((e=>parseFloat(e)))),this._style.setTransform(t),this.needsUpdate()}getTransform(){return this._style.getTransform()}set domId(e){this._domId=e,this.needsUpdate()}get domId(){return this._domId}setCode(e,t){if(!e)return void console.log("code is empty for ",this);let s,i=[];s="string"==typeof e?[e]:e,this._code=s,s.forEach((e=>{let t,s=e.trim();if(0===s.length)return;t=/^class[ \t]/.test(s)?s:this.getLibrary(s),t||console.log(`code specified as ${s} is empty for`,this);let n=new Function("getElement",`let x = ${t}; return x;`)(getElement);"function"==typeof n?i.push(n):console.log("error occured while compiling")})),this.$handlers||(this.$handlers={});let n=this.$handlers;Object.keys(n).forEach((e=>{n[e]&&n["_"+e]&&(delete n[e],delete n["_"+e])})),i.forEach((e=>{let s=e.name;n[s]=e.prototype,n["_"+s]=e,!t&&e.prototype.init&&this.call(e.name,"init")}))}getCode(){return this._code}addCode(e){if(!e)return void console.log("additional code is empty for ",this);let t;t="string"==typeof e?[e]:e;let s=this.getCode().slice();for(let e=0;e<t.length;e++){let i=t[e];if(!(s.indexOf(i)>=0)&&i.startsWith("class")){let e=new Function("getElement",`let x = ${i}; return x;`)(getElement);for(let t=0;t<s.length;t++){let i=s[t];if(i.startsWith("class")){new Function("getElement",`let x = ${i}; return x;`)(getElement).name===e.name&&s.splice(t,1)}}}}s=s.concat(t),this.setCode(s)}setViewCode(e){if(!e)return void console.log("code is empty for ",this);let t;t="string"==typeof e?[e]:e,this._viewCode=t,this.needsUpdate()}getViewCode(){return this._viewCode}addViewCode(e){if(!e)return void console.log("additional code is empty for ",this);let t;t="string"==typeof e?[e]:e,t=this.getViewCode().concat(t),this.setViewCode(t)}setStyleString(e){this._style.setStyleString(e),this.needsUpdate()}getStyleString(){return this._style.getStyleString()}setStyleClasses(e){this._style.setClasses(e)}addStyleClasses(e){let t=this.getStyleClasses()||"";this._style.setClasses(t+"\n"+e)}getStyleClasses(){return this._style.getClasses()}setClassList(e){this._classList=e,this.needsUpdate()}getClassList(){return this._classList}setScriptingInfo(e){let t=e.indexOf("id:\n")+"id:\n".length,s=e.indexOf("classes:\n"),i=s+"classes:\n".length,n=e.indexOf("props:\n"),r=n+"props:\n".length,l=e.slice(t,s),o=e.slice(i,n),h=e.slice(r);this.domId=l.trim(),h.split("\n").forEach((e=>{let t=e.indexOf(": ");if(t<1)return;let s=e.slice(0,t),i=parse(e.slice(t+2));this._set(s,i)}));let a=o.split(",").map((e=>e.trim())).filter((e=>e.length>0));this.setClassList(a)}getScriptingInfo(){let e=this.domId,t=this._me,s=[];t.forEach(((e,t)=>{void 0!==e&&s.push(t+": "+stringify(e))}));let i=s.join("\n");return`id:\n${e||""}\nclasses:\n${this.getClassList().join(",")}\nprops:\n${i}\n`}setScriptingDataObject(e){this._me=e.get("me"),this._classList=e.get("classList"),this.domId=e.get("domId")}getScriptingDataObject(){let e=new Map;return e.set("me",new Map(this._me)),e.set("classList",this._classList.slice()),e.set("domId",this.domId),e}set innerHTML(e){this.setInnerHTML(e)}get innerHTML(){return this._innerHTML}setInnerHTML(e){return this._innerHTML=e,this.needsUpdate(),e}getListenersInfo(){let e=this._listeners;if(0!==e.length)return stringify(e)}setListenersInfo(e){if(!e)return;let t=parse(e);this._listeners=t}addEventListener(e,t,s){let i,n=this._trait;n&&(n=n.constructor.name),t.indexOf(".")>=1||!n?i=t:n&&(i=`${n}.${t}`),this._eventListeners.set(e,{spec:i,useCapture:s}),this.needsUpdate()}removeEventListener(e,t){this._eventListeners.delete(e),this.needsUpdate()}querySelector(e){if("#"!==e[0])return null;let t=e.slice(1),query=e=>{if(e._domId===t)return e;let s=e._childNodes;for(let e=0;e<s.length;e++){let t=s[e],i=this.getElement(t),n=query(i);if(n)return n}return null};return query(this)}getLibrary(e){let t,s=e.split(".");if(s.length<=1)return null;let i=s[0],n=this;for(;n;){if(t=n._get("library"),t&&t.has(i))return t.get(e);let s=n.parentNode;if(!s)break;n=s}return t=Library.getGlobalLibrary(),t.get(e)}_set(e,t){return this._me.set(e,t),t}_get(e){return this._me.get(e)}_delete(e){let t=this._me.get(e);return this._me.delete(e),t}domEvent(e){let{elementId:t,evt:s,trait:i,method:n}=e,r=this.getWorldState().getElement(t);r&&(r.call(i,n,s),this.needsUpdate())}ensureMyHandler(){if(!this.$handlers){this.$handlers={};let e=this.getCode();e.length>0&&this.setCode(e,!0),e=this.getViewCode(),e.length>0&&this.setViewCode(e),e=this.getStyleString(),e.length>0&&this.setStyleString(e)}return this.$handlers}hasHandler(e){return!!this.ensureMyHandler()[e]}bePartsBinPrototype(){this.style.setProperty("background-color","white"),this.style.setProperty("border","1px solid black"),this.style.setProperty("width","50px"),this.style.setProperty("height","40px"),this.style.setProperty("position","absolute"),this.style.setProperty("left","0px"),this.style.setProperty("top","0px")}call(e,t,...s){let i,n,r=this.ensureMyHandler();if(e&&(i=r[e]),e&&!i)throw new Error(`an expander named ${e} is not installed`);let l=newProxy(this,0,i);try{let i=l[t];if(!i)throw new Error(`a method named ${t} not found in ${e||this}`);n=i.apply(l,s)}catch(s){console.error("an error occured in",this,e,t,s)}return n}publishToAll(e){this._listeners.forEach((t=>{this.publish(t.scope||this.id,t.event,e)}))}addDomain(e,t){let s=this._listeners;if(s.findIndex((s=>s.scope===e&&s.event===t))>=0)return;let i=s.slice();i.push({scope:e,event:t}),this._listeners=i}}Element.register("Element");let a=null,d={};window.views=d;let c={};class TopView extends l{constructor(e){super(e),this.model=e,this.ensureDom(),a=this,window.topView=a,this.isSynced=!1,this.pointerTracker=null,this.subscribe(this.viewId,"synced","synced"),this.subscribe(this.sessionId,"resizeWindow","resizeWindow"),document.addEventListener("drop",(e=>e.preventDefault())),document.addEventListener("dragover",(e=>e.preventDefault())),this.grabber=new GlobalPointerGrabber,this.initializer=[],this.detachCallbacks=[]}subscribe(e,s,i){return t?super.subscribe(e,s,i):super.subscribe(e,s,this[i])}isRunningLocally(){return t}detach(){super.detach();for(let e in d)d[e].dom.remove(),d[e].detach();this.pluggableDispatch("pointerTracker","deleteAllPointers"),d={},window.views=d,this.dom.childNodes[0]&&this.dom.childNodes[0].remove(),this.hasChild=!1,this.dom.remove(),console.log("detach top"),this.detachCallbacks.forEach((e=>{if("function"==typeof e)e();else{let{view:t,trait:s,method:i}=e;t.call(s,i)}})),this.detachCallbacks=[],this.grabber&&(this.grabber.releasePointer(),this.grabber=null)}synced(e){console.log(`top view synced(${e})`),this.isSynced=e}ensureDom(){if(this.dom)return;document.body.style.setProperty("overscroll-behavior-x","none"),document.body.style.setProperty("overflow","hidden"),document.body.style.setProperty("height","100%"),document.body.style.setProperty("margin","0"),this.dom=document.createElement("div"),this.dom.id="toplevel",this.dom.style.setProperty("width","100%"),this.dom.style.setProperty("height","100%"),this.hasChild=!1;let e=document.querySelector("#croquet-root");e||(e=document.body),e.appendChild(this.dom),window.onresize=()=>this.throttledInvoke("resizeWindow",200,(()=>this.localResizeWindow())),this.localResizeWindow()}localResizeWindow(){if(window.isMaster){let e=this.dom.getBoundingClientRect();this.publish(this.sessionId,"windowResized",{width:e.width+"px",height:e.height+"px"})}else this.publish(this.sessionId,"localWindowResized")}resizeWindow(){let e=this.model.containerExtent;this.dom.style.setProperty("width",e.width),this.dom.style.setProperty("height",e.height)}pluggableDispatch(e,t,s){let i=this[e];return i?i.target.call(i.trait,i[t],s):null}grab(e,t,s,i){this.grabber.grab(e,t,s,i)}ensureView(e,t){let s=e.asKey(),i=e.elementId,n=d[s];if(n)return n;let r=t.getElement(i);return n=new(r.constructor.viewClass()||ElementView)(r),n.setKey(s),d[s]=n,n}removeView(e){let t=d[e];return t?(t.detach(),t.dom.remove(),delete d[e],t):t}querySelector(e){if("#"!==e[0])return null;let t=this.dom.querySelector(e);if(!t)return null;let s=t.key;return s?window.views[s]:null}requestFullUpdate(){this.fullUpdate=!0}requestUpdate(){let e,t,s=this.model.wellKnownModel("worldModel"),i=s.changedElements(this.fullUpdate);if(i.elementIds.forEach((n=>{let r=s.getElement(n);if(!r){return this.removeView(asKey(n)),void removeStyle(shortId(n))}this.ensureView(new ElementRef(n),s).apply(i.time,r,s),!this.hasChild&&r.topChild&&(e=r,t=s)})),this.fullUpdate=!1,e){this.hasChild=!0;let s=this.ensureView(new ElementRef(e.elementId),t);this.dom.appendChild(s.dom)}for(let e in c){let t=c[e];t[0].call(t[1],"init")}if(c={},this.initializer.length>0&&!this.initializerTimer){let e=[...this.initializer];this.initializer=[],this.initializerTimer=window.setTimeout((()=>{e.forEach((e=>{let[t,s,i]=e;t.call(s,i)})),this.initializerTimer=null}),500)}}requestInitialization(e,t,s){this.initializer.push([e,t,s])}displayStatus(e){console.log(e)}displayWarning(e){console.log(e)}displayError(e){console.log(e)}update(){this.isSynced&&this.requestUpdate()}throttledInvoke(e,t,s){if(-1===t)return void s();this.throttles||(this.throttles={});let i=this.throttles[e];if(i||(i=this.throttles[e]={}),i.fn=s,i.timeout)return;let n=Date.now(),r=i.lastInvoke?i.lastInvoke+t-n:0;if(r<=0)return i.lastInvoke=n,void s();i.timeout=setTimeout((()=>{delete i.timeout,i.lastInvoke=Date.now(),i.fn()}),r)}clearThrottledInvoke(e){if(!this.throttles)return;let t=this.throttles[e];t&&t.timeout&&clearTimeout(t.timeout),delete this.throttles[e]}setLastFontLoadedTime(e){o&&o(e)}}function equal(e,t){if(typeof e!=typeof t)return!1;if("object"==typeof e){if(null===e||null===t)return e===t;if(e.constructor!==t.constructor)return!1;if(e.constructor===Array){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!equal(e[s],t[s]))return!1;return!0}if(e.constructor===Map){if(e.size!==t.size)return!1;for(let s of e.keys())if(!equal(e.get(s),t.get(s)))return!1;return!0}let s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(let s in e)if(!equal(e[s],t[s]))return!1}return e===t}class ElementView extends l{constructor(e){super(e),this.model=e,this.dom=this.createDom(),this.dom._cards=!0,this._elementId=e.elementId,this._lastValues=new Map,this._viewHandlers={},this._eventListeners=new Map,this.model.isWorld&&this.subscribe(this.viewId,"synced","synced")}detach(){super.detach(),this.model.isWorld&&(this.isSynced=!1),this._objectURL&&(URL.revokeObjectURL(this._objectURL),this._objectURL=null),removeStyle(shortId(this._elementId))}createDom(){return document.createElement("div")}synced(e){console.log("element view synced",e,this.model.elementId),this.isSynced=e}subscribe(e,s,i){if(t)return super.subscribe(e,s,i);if(i.indexOf(".")>=1){let t=i.split("."),func=e=>{this.call(t[0],t[1],e)};return super.subscribe(e,s,func)}return super.subscribe(e,s,this[i])}hasHandler(e){return!!this._viewHandlers[e]}call(e,t,...s){let i,n,r=this._viewHandlers;if(e&&(i=r[e]),e&&!i)throw new Error(`an expander named ${e} is not installed`);let l=newProxy(this,0,i);try{let i=l[t];if(!i)throw new Error(`a method named ${t} not found in ${e||this}`);n=i.apply(l,s)}catch(s){console.error("an error occured in",this,e,t,s)}return n}eventKeyFromSpec(e,t){let s,i=this._trait;return i&&(i=i.constructor.name),t.indexOf(".")>=1||!i?s=t:i&&(s=`${i}.${t}`),[s,"_"+e+"_"+s]}addEventListener(e,t){let[s,i]=this.eventKeyFromSpec(e,t);this._viewHandlers[i]&&(console.log("most likely to be duplicate"),this.removeEventListener(e,t));let n,r,l=s.split(".");l[1]?(r=l[0],n=l[1]):n=l[0];let func=e=>{let t=e;"drop"!==e.type&&"scroll"!==e.type&&(t=this.cookEvent(e)),this.call(r,n,t)};this._viewHandlers[i]=func,this.dom.addEventListener(e,func)}removeEventListener(e,t){let[s,i]=this.eventKeyFromSpec(e,t);this._viewHandlers[i]&&(this.dom.removeEventListener(e,this._viewHandlers[i]),delete this._viewHandlers[i])}setKey(e){this.dom.key=e}querySelector(e){if("#"!==e[0])return null;let t=this.dom.querySelector(e);if(!t)return null;let s=t.key;return s?window.views[s]:null}cookEvent(e){let t=e.target.key;if("scroll"===e.type)return{target:t,type:"scroll"};if("pointerover"===e.type||"pointerenter"===e.type||"pointerdown"===e.type||"pointermove"===e.type||"pointerup"===e.type||"pointercancel"===e.type||"pointerout"===e.type||"pointerleave"===e.type||"gotpointercapture"===e.type||"lostpointercapture"===e.type){let s=e.clientX,i=e.clientY,n=e.offsetX,r=e.offsetY;e.shiftKey&&e.stopPropagation();let l={pointerId:e.pointerId,buttons:e.buttons,isPrimary:e.isPrimary,type:e.type,target:t,clientX:s,clientY:i,offsetX:n,offsetY:r,shiftKey:e.shiftKey,pressure:e.pressure,force:e.force,width:e.width,height:e.height,stopPropagation:()=>e.stopPropagation(),preventDefault:()=>e.preventDefault()};return"wheel"===e.type&&(l.deltaX=e.deltaX,l.deltaY=e.deltaY),l}if("mousedown"===e.type||"mousemove"===e.type||"mouseup"===e.type||"click"===e.type||"wheel"===e.type||"dblclick"===e.type||"touchstart"===e.type||"touchmove"===e.type||"touchend"===e.type){let s=e.touches&&e.touches[0]?e.touches[0]:e,i=s.clientX,n=s.clientY,r=s.offsetX,l=s.offsetY;e.shiftKey&&e.stopPropagation();let o={type:e.type,touches:e.touches,target:t,clientX:i,clientY:n,offsetX:r,offsetY:l,force:e.force,altitudeAngle:e.altitudeAngle,azimuthAngle:e.azimuthAngle,buttons:e.buttons,shiftKey:e.shiftKey,stopPropagation:()=>e.stopPropagation(),preventDefault:()=>e.preventDefault()};return"wheel"===e.type&&(o.deltaX=e.deltaX,o.deltaY=e.deltaY),o}return{key:e.key,target:t,metaKey:e.metaKey,altKey:e.altKey,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,stopPropagation:()=>e.stopPropagation(),preventDefault:()=>e.preventDefault()}}updateChildNodes(e,t){let s=t._childNodes;if(equal(this._lastValues.get("childNodes"),s))return;this._lastValues.set("childNodes",s);let i=Array.from(this.dom.childNodes),n=0,r=0,l=[],find=(e,t,s)=>{for(let i=s;i<e.length;i++){if(t===e[i].asKey())return i}return-1};for(;!(n>=i.length);){let e=s[r],t=i[n],o=t.key;if(!o)break;if(e&&o===e.asKey())r++,n++;else{let e=find(s,o,r),i=find(s,o,0);if(e<0&&i>=0)break;e>=0?(r=e+1,n++):(l.push(t),n++)}}if(n===i.length&&r<=s.length)for(n=0,r=0;!(r>=s.length&&0===l.length);){let e=s[r],t=i[n];if(t)if(l.length>0&&l[0]===t){let e=t.key;t.remove(),l.shift();let s=d[e];s&&s.detach(),n++}else{if(t.key!==e.asKey()){let{elementId:s}=e,i=this.model.wellKnownModel("worldModel"),n=a.ensureView(new ElementRef(s),i);n.model.topChild?a.dom.insertBefore(n.dom,t):(this.dom.insertBefore(n.dom,t),n.parentNode=this),r++;continue}n++,r++}else{let{elementId:t}=e,s=this.model.wellKnownModel("worldModel"),i=a.ensureView(new ElementRef(t),s);i.model.topChild?a.dom.appendChild(i.dom):(this.dom.appendChild(i.dom),i.parentNode=this),r++}}else i.forEach((e=>{e._cards&&e.remove()})),s.forEach((e=>{let{elementId:t}=e,s=this.model.wellKnownModel("worldModel"),i=a.ensureView(new ElementRef(t),s);i.model.topChild?a.dom.appendChild(i.dom):(this.dom.appendChild(i.dom),i.parentNode=this)}))}apply(e,t,s){let i;if(i=t._domId,this._lastValues.get("domId")!==i&&(this._lastValues.set("domId",i),this.dom.id=i),i=t._classList,!equal(this._lastValues.get("classList"),i)){this._lastValues.set("classList",i);let e=this.dom.classList;for(let t=e.length-1;t>=0;t--)this.dom.classList.remove(e[t]);for(let e=0;e<i.length;e++)this.dom.classList.add(i[e])}this.updateChildNodes(e,t,s),i=t._innerHTML,"string"==typeof i&&this._lastValues.get("innerHTML")!==i&&(this._lastValues.set("innerHTML",i),this.dom.innerHTML=i),i=t._eventListeners,this.addDomEventListenersFor(t,this,i);let n=t._style.local,r=this._lastValues.get("style")||new Map,l=new Map;if(n.get("-cards-direct-manipulation")){if(i=t._style.getTransform(),!equal(this._lastValues.get("transform"),i)){this._lastValues.set("transform",i);let[e,t,s,n,r,l]=i;this.dom.style.setProperty("transform",`matrix(${e}, ${t}, ${s}, ${n}, ${r}, ${l})`)}if(i=t._style.getTransformOrigin(),equal(this._lastValues.get("transform-origin"),i)||(this._lastValues.set("transform-origin",i),this.dom.style.setProperty("transform-origin",i)),i=n.get("width"),l.set("width",i),r.delete("width"),!equal(r.get("width"),i))if(void 0!==i){let e="string"==typeof i?i:i+"px";this.dom.style.setProperty("width",e)}else this.dom.style.removeProperty("width");if(i=n.get("height"),l.set("height",i),r.delete("height"),!equal(r.get("height"),i))if(void 0!==i){r.delete("height");let e="string"==typeof i?i:i+"px";this.dom.style.setProperty("height",e)}else this.dom.style.removeProperty("height")}n.forEach(((e,t)=>{(!n.get("-cards-direct-manipulation")||"width"!==t&&"height"!==t)&&(t.startsWith("-cards-")?l.set(t,e):(l.set(t,e),r.delete(t),e!==r.get(t)&&this.dom.style.setProperty(t,e)))}));let o=s._get("target");o&&o.elementId===t.elementId&&(l.set("background-color","#9CC6E7"),this.dom.style.setProperty("background-color","#9CC6E7"));let h="-cards-background-image-asset";if(!equal(r.get(h),n.get(h))){let e=n.get(h);l.set(h,e),e?Croquet.Data.fetch(this.sessionId,e.handle).then((t=>{const s=new Blob([t],{type:e.type});this._objectURL&&URL.revokeObjectURL(this._objectURL),this._objectURL=URL.createObjectURL(s),this.dom.style.setProperty("background-image",`url(${this._objectURL}`)})):(this.dom.style.removeProperty("background-image"),this._objectURL&&URL.revokeObjectURL(this._objectURL))}this._lastValues.set("style",l);for(let e of r.keys())this.dom.style.removeProperty(e);let a=t._style.classes;if(this._lastValues.get("classes")!==a){this._lastValues.set("classes",a);let e=shortId(this._elementId);if(removeStyle(e),a){let t=document.createElement("style");t.innerHTML=a,t.id=`style${e}`,document.body.appendChild(t)}}i=t._viewCode,equal(this._lastValues.get("viewCode"),i)||(this._lastValues.set("viewCode",i),this.addViewCode(t,this,i))}addDomEventListenersFor(e,t,s){let i=e.elementId,n=new Map(this._eventListeners);for(let r of s.keys()){let l,o,h=s.get(r),a=h.spec,d=h.useCapture;if(this._eventListeners.get(r)&&this._eventListeners.get(r).spec===a&&this._eventListeners.get(r).useCapture===d){n.delete(r);continue}let c=a.split(".");c.length>1?(l=c[0],o=c[1]):o=a,!this._eventListeners.get(r)||this._eventListeners.get(r).spec===a&&this._eventListeners.get(r).useCapture===d||(t.dom.removeEventListener(r,this._eventListeners.get(r).func),this._eventListeners.delete(r));let func=t=>{t.preventDefault();let s=this.cookEvent(t),n=e.getWorldState(),r=e.getElement(n.elementId).id;delete s.stopPropagation,delete s.preventDefault,this.publish(r,"domEvent",{elementId:i,evt:s,trait:l,method:o})};this._eventListeners.set(r,{func:func,spec:a,useCapture:d}),t.dom.addEventListener(r,func,d),n.delete(r)}for(let e of n.keys())t.dom.removeEventListener(e,this._eventListeners.get(e).func),this._eventListeners.delete(e)}addViewCode(e,t,s){let i=this._viewHandlers;Object.keys(i).forEach((e=>{i[e]&&i["_"+e]&&(delete i[e],delete i["_"+e])})),s.forEach((e=>{let t,s=e.trim();if(0===s.length)return;t=/^class[ \t]/.test(s)?s:this.model.getLibrary(s),t||console.log(`code specified as ${s} is empty for`,this);let n=new Function(`let x = ${t}; return x;`)();if("function"!=typeof n)return void console.log("error occured while compiling");let r=n.name;i[r]=n.prototype,i["_"+r]=n,n.prototype.init&&(c[this.id+"."+r]=[this,r])}))}publishToAll(e){this.model._listeners.forEach((t=>{this.publish(t.scope||this.model.sessionId,t.event,e)}))}addDomain(e,t){let s=this.model._listeners;if(s.findIndex((s=>s.scope===e&&s.event===t))>=0)return;let i=s.slice();i.push({scope:e,event:t}),this.listeners=i}setPointerCapture(e){window.topView.grabber.capturePointer(e,this.dom)}releasePointerCapture(e){window.topView.grabber.releasePointer(e,this.dom)}releaseAllPointerCapture(){window.topView.grabber.releasePointer()}}class GlobalPointerGrabber{constructor(){this.move=null,this.up=null,this.target=null,this.forTouch=!1,this.pointerCaptureMap=new Map}grab(e,t,s,i){let n,r,removeListeners=()=>{window.removeEventListener("mousemove",this.move,!0),window.removeEventListener("mouseup",this.up),window.ondragstart=null,this.forTouch&&(a.dom.removeEventListener("touchmove",this.move,!0),a.dom.removeEventListener("touchend",this.up,!0))};if(this.up&&(console.error("new grab with previous still defined"),removeListeners()),this.target=e.dom.key,this.forTouch=i,"function"==typeof t)n=t;else{let s=t.split(".");n=t=>e.call(s[0],s[1],t)}if(this.move=e=>{n(e)},"function"==typeof s)r=s;else{let t=s.split(".");r=s=>e.call(t[0],t[1],s)}this.up=e=>{e.preventDefault(),e.stopPropagation(),removeListeners(),this.move=null,this.up=null,this.target=null,this.forTouch=!1,r(e)},window.addEventListener("mousemove",this.move,!0),window.addEventListener("mouseup",this.up),window.ondragstart=e=>{console.log("canceling spurious drag event"),e.preventDefault(),e.stopPropagation()},i&&(a.dom.addEventListener("touchmove",this.move,!0),a.dom.addEventListener("touchend",this.up,!0))}capturePointer(e,t){t.setPointerCapture&&(t.setPointerCapture(e),this.pointerCaptureMap.set(e,t))}releasePointer(e,t){if(void 0===e)this.pointerCaptureMap.forEach(((e,t)=>{try{e.releasePointerCapture(t)}catch(e){}})),this.pointerCaptureMap.clear();else{let s=this.pointerCaptureMap.get(e);t!==s&&console.log("inconsistent capture");try{s.releasePointerCapture(e)}finally{this.pointerCaptureMap.delete(e)}}}}function start(e="elem",t,s,i={}){return i.options&&(i.options.sessionName=e,i.options.appId=i.appId),createSession(e,t||TopModel,s||TopView,i)}class CanvasElement extends Element{static viewClass(){return CanvasView}init(){super.init()}setExtent(e,t,s){this.style.setProperty("-cards-pixelWidth",e),this.style.setProperty("-cards-pixelHeight",t),void 0!==s&&this.style.setProperty("-cards-retain-pixels",s)}bePartsBinPrototype(){super.bePartsBinPrototype(),this.style.setProperty("width","200px"),this.style.setProperty("height","200px"),this.style.setProperty("-cards-pixelWidth","200px"),this.style.setProperty("-cards-pixelHeight","200px")}}CanvasElement.register("CanvasElement");class CanvasView extends ElementView{createDom(){return document.createElement("canvas")}apply(e,t,s){super.apply(e,t,s);let i,n=t._style.local,r=!1;if(["-cards-pixelWidth","-cards-pixelHeight"].forEach((e=>{let t=n.get(e)||200;this._lastValues.get(e)!==t&&(r=r||!0)})),r&&n.get("-cards-retain-pixels")&&this.dom.width>0&&this.dom.height>0){i=this.dom.getContext("2d").getImageData(0,0,this.dom.width,this.dom.height)}if([["-cards-pixelWidth","width"],["-cards-pixelHeight","height"]].forEach((e=>{let[t,s]=e,i=n.get(t)||200;this._lastValues.get(t)!==i&&(this._lastValues.set(t,i),this.dom[s]=parseFloat(i))})),i){this.dom.getContext("2d").putImageData(i,0,0)}if(n.get("-cards-resize-callback")){let e=n.get("-cards-resize-callback").split(".");this.call(e[0],e[1])}}}function maybeSelectCommentOrLine(e){var t=e.selection,{row:s,column:i}=t.lead,n=e.selectionOrLineString();if(t.isEmpty()){var r=n.indexOf("//");-1===r||i<r||r>0&&":\"'".indexOf(n[r-1])>=0?e.selectLine(s):t.range={start:{row:s,column:r+2},end:{row:s,column:n.length}}}}function doEval(e,t,s,i){t||(t=e.selection.isEmpty()?e.lineRange():e.selection.range),i||(i=e.textInRange(t))}let u={doit:{doc:"Evaluates the selected code or the current line and report the result",exec:async(e,t,s=1)=>{let i,n;maybeSelectCommentOrLine(e);try{t=Object.assign({},t,{inspect:!0,inspectDepth:s}),i=await doEval(e,void 0),n=i.isError?i.value:null}catch(e){n=e}return n&&console.log("**"+n),i}},printit:{doc:"Evaluates selected code or the current line and inserts the result in a printed representation",exec:async(e,t)=>{let s,i;maybeSelectCommentOrLine(e);try{t=Object.assign({},t,{asString:!0}),s=await doEval(e,void 0),i=s.isError?s.value:null}catch(e){i=e}return e.selection.collapseToEnd(),e.insertTextAndSelect(i?String(i)+(i.stack?"\n"+i.stack:""):String(s.value)),s}}};Object.assign({},{"clipboard copy":{doc:"placeholder for native copy",exec:e=>!1},"clipboard cut":{doc:"placeholder for native cut",exec:e=>!1},"clipboard paste":{doc:"placeholder for native paste",exec:e=>!1}},u);let p=[[""],["shift"],["alt"],["alt","shift"],["ctrl"],["ctrl","shift"],["ctrl","alt"],["ctrl","alt","shift"],["meta"],["meta","shift"],["meta","alt"],["meta","alt","shift"],["meta","ctrl"],["meta","ctrl","shift"],["meta","ctrl","alt"],["meta","shift","alt","shift"]],f={shift:1,alt:2,option:2,control:4,ctrl:4,super:8,win:8,meta:8,command:8,cmd:8};function cap(e){return e[0].toUpperCase()+e.slice(1)}function eventToKeyCombo(e,t,s){let i=s.key,n=s.keyIdentifier;if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(s.key)>=0)return s.key;if([10,13,8,46].indexOf(s.keyCode)>=0)return s.key;if(0===e||1===e)return null;if(!i&&n&&(i=function decodeKeyIdentifier(e,t){let s=e&&e.replace(/u\+?([\d\w]{4})/gi,((e,t)=>String.fromCharCode(parseInt(t,16))));return"Command"!==s&&"Cmd"!==s||(s="Meta")," "===s&&(s="Space"),8===t&&(s="Backspace"),s}(n,s.which||s.keyCode),s.key=i=i[s.shiftKey?"toUpperCase":"toLowerCase"](),function isModifier(e){return!function(e){return/^[0-9]+$/.test(e)}(e)&&(e=e.replace(/-$/,"").toLowerCase(),!!f[e])}(i)))return cap(i[0]);let r=p[e];s.code&&(i=function identifyKeyFromCode(e){let t=e.code;if("string"!=typeof t)return null;if(t.startsWith("Key"))return t.slice(3);if(t.startsWith("Numpad"))return t;if(t.startsWith("Digit"))return t.slice(5);if(t.startsWith("Arrow"))return t.slice(5);if(t.match(/^F[0-9]{1-2}$/))return t;switch(t){case"Insert":case"Home":case"PageUp":case"PageDown":return t;case"Period":return".";case"Comma":return",";case"Help":return"Insert";case"Equal":return"=";case"Backslash":case"IntlBackslash":return"\\";case"Minus":return"-";case"BracketRight":return"]";case"BracketLeft":return"[";case"Quote":return"'";case"Backquote":return"`";case"Semicolon":return";";default:return null}}(s)||i);let l=r.map(cap).join("-");return t||(l+=i?"-"+i:""),l}function canonicalizeKeyboardEvent(e){let t=0,s={keyCombo:"",key:"",shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:e.type,keyCode:e.keyCode};Object.keys(f).forEach((i=>{let n=i+"Key";e[n]&&(t|=f[i],s[n]=!0)})),f[e.key.toLowerCase()]&&(s.onlyModifiers=!0);let i=eventToKeyCombo(t,s.onlyModifiers,e);if(!i)return null;if(0===t||1===t)return s.keyCombo=i,s.key=e.key,1===t&&(s.onlyShiftModifier=!0,s.isModified=!0),s;if(t>1&&(s.isModified=!0),s.onlyModifiers)return s.keyCombo=i,s.key=e.key,s.onlyModifiers=!0,s;let n=function canonicalizeFunctionKey(e){switch(e=e.toLowerCase()){case"space":e="space";break;case"esc":e="escape";break;case"return":e="enter";break;case"arrowleft":e="left";break;case"arrowright":e="right";break;case"arrowup":e="up";break;case"arrowdown":e="down"}return["backspace","tab","enter","pause","escape"," ","pageup","pagedown","end","home","left","up","right","down","print","insert","delete","numpad0","numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9","numpadenter","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"].includes(e)?cap(e):""}(e.key);if(n)s.isFunctionKey=!0,s.key=n;else{if(!s.isModified)return null;s.onlyShiftModifier?s.key=e.key:s.key=e.key[0].toUpperCase()+e.key.slice(1)}return s.keyCombo=i,s}const m=String.fromCharCode(26);function isNewline(e){return!!/[\n\r]/.test(e)}function equalStyle(e,t,s,i){return!e&&!t||(e?t?(e.font||s)===(t.font||s)&&(e.size||i)===(t.size||i)&&e.color===t.color&&!!e.bold==!!t.bold&&!!e.italic==!!t.italic:e.font===s&&e.size===i&&!e.color&&!e.bold&&!e.italic:t.font===s&&t.size===i&&!t.color&&!t.bold&&!t.italic)}let y={measureText:(e,t,s)=>({width:20*e.text.length,height:50,ascent:40}),getInfo:(e,t)=>({common:{lineHeight:50}})};class MetricCache{constructor(){this.cache=[new Map],this.maxMaps=4,this.limit=256}makeKey(e,t,s){let i={font:t,size:s,style:e.style,styles:e.styles,text:e.text};return JSON.stringify(i)}lookup(e){for(let t=0;t<this.cache.length;t++){let s=this.cache[t].get(e);if(s)return{...s}}return null}update(e,t){let s=this.cache[this.cache.length-1];if(s.set(e,t),s.size>=this.limit){if(this.cache.length===this.maxMaps){let e=Math.floor(Math.random()*this.cache.length);this.cache.splice(e,1)}this.cache.push(new Map)}}}y=new class DomFontRegistry{spanFor(e,t){let s=document.createElement("span");return s.textContent=e,t&&(t.font&&s.style.setProperty("font-family",t.font),t.size&&s.style.setProperty("font-size",t.size+"px"),t.bold&&s.style.setProperty("font-weight","700"),t.italic&&s.style.setProperty("font-style","italic")),s}measureText(e,t,s){this.ensureMeasureDiv(),this.div.style.setProperty("font-family",t),this.div.style.setProperty("font-size",s+"px");let i=e.text;if(""===i){this.div.textContent="";let e=this.div.getBoundingClientRect();return{width:e.width,height:e.height,ascent:e.height/2}}if(" "===i||i===m){let t=this.spanFor("a a",e.style);this.div.appendChild(t);let s=this.div.getBoundingClientRect();t.remove(),t=this.spanFor("aa",e.style),this.div.appendChild(t);let i=this.div.getBoundingClientRect();return t.remove(),{width:s.width-i.width,height:s.height,ascent:s.height/2}}if(isNewline(i)){let i={...e};i.text=" ";let n=this.measureText(i,t,s);return n.width=0,n}if("\t"===i){let e=this.spanFor("m",null);this.div.appendChild(e);let t=this.div.getBoundingClientRect();return e.remove(),{width:20,height:t.height,ascent:t.height/2}}if(e.styles){this.div.textContent="";for(let t=0;t<e.styles.length;t++){let s=e.styles[t];if(s.start>=e.text.length)break;let i=this.spanFor(e.text.slice(s.start,s.end),s.style);this.div.appendChild(i)}let t=this.div.getBoundingClientRect();for(;this.div.lastChild;)this.div.lastChild.remove();return{width:t.width,height:t.height,ascent:t.height/2}}if(e.style){this.div.textContent="";let t=this.spanFor(e.text,e.style);this.div.appendChild(t);let s=this.div.getBoundingClientRect();for(;this.div.lastChild;)this.div.lastChild.remove();return{width:s.width,height:s.height,ascent:s.height/2}}let n=this.spanFor(e.text,e.style);this.div.appendChild(n);let r=this.div.getBoundingClientRect();return n.remove(),{width:r.width,height:r.height,ascent:r.height/2}}ensureMeasureDiv(){this.div||(this.div=document.createElement("div"),this.div.classList.add("text-div"),this.div.style.setProperty("position","absolute"),this.div.style.setProperty("left","0px"),this.div.style.setProperty("top","-600px"),this.div.style.setProperty("visibility","hidden"),this.div.style.setProperty("width","auto"),this.div.style.setProperty("height","auto"),this.div.style.setProperty("white-space","nowrap"),document.body.appendChild(this.div))}getInfo(e,t){return{common:{lineHeight:t}}}};class Measurer{constructor(){this.cache=new MetricCache}measureText(e,t,s){let i=this.cache.makeKey(e,t,s),n=this.cache.lookup(i);return n||(n=y.measureText(e,t,s),this.cache.update(i,n),n)}lineHeight(e,t){return y.getInfo(e,t).common.lineHeight}}class Wrap{splitWords(e,t,s){const isSpace=e=>!!/[ \f\n\r\t\v\u00A0\u2028\u2029]/.test(e);let i,n,r,push=(e,t,s)=>{s&&s.length>1?l.push(Object.assign(e,{styles:s})):s&&1===s.length?l.push(Object.assign(e,{style:s[0].style})):t?l.push(Object.assign(e,{style:t})):l.push(e)},stylePush=(e,i)=>{if(!e)return[i];let n=e[e.length-1];return equalStyle(n.style,i.style,t,s)?(n.end=i.end,e):(e.push(i),e)},l=[],o=0,h="",a=null;for(let t=0;t<e.length-1;t++){void 0===i&&(i=!isSpace(e[0].text[0]));let s=e[t],l=s.text;n=s.style,i||(i=!isSpace(l[0]));let d=0;for(let e=0;e<l.length;e++)if(0!==o||0!==t||0!==e)if(i){if(isSpace(l[e])){r=l.slice(d,e);let t=h.length>0&&0===r.length;if(h.length>0){if(r.length>0){a=stylePush(a,{start:h.length,end:h.length+r.length,style:n})}r=h+r,h=""}push({start:o,end:o+r.length,text:r},t?null:n,a),o+=r.length,d=e,i=!1,a=null}}else e>0&&(push({start:o,end:o+1,text:l[e-1],style:n,styles:a}),o+=1,d+=1),isSpace(l[e])||(i=!0);if(r=l.slice(d,l.length),1===r.length&&isSpace(r))push({start:o,end:o+1,text:r,style:n,styles:a}),o+=1;else{a=stylePush(a,{start:h.length,end:h.length+r.length,style:n}),h+=r}}let d=o;if(h.length>0){d=o+h.length;let e={start:o,end:d,text:h};a&&1===a.length&&equalStyle(n,a[0].style,t,s)?push(e,n):push(e,null,a)}return push({start:d,end:d+1,text:m}),l}mergeRect(e,t){return e?t?{width:e.width+t.width,height:Math.max(e.height,t.height),ascent:Math.max(e.ascent,t.ascent)}:e:t}wrap(e,t,s,i,n,r){r||(r={left:0,top:0,right:0,bottom:0});const l=t-r.left-r.right;let o=[],h=0,a=0,d=[],c=r.left,u=r.top,p=this.splitWords(e,i,n),pushLine=()=>{0!==o.length&&(o.forEach((e=>{e.ascent=a})),d.push(o),o=[],c=r.left,u+=h,h=0,a=0)};for(let e=0;e<p.length-1;e++){let t,r=p[e];isNewline(r.text)?(t=s.measureText(r,i,n),e===p.length-1?pushLine():(h=Math.max(h,t.height),a=Math.max(a,t.ascent)),t.left=c,t.top=u,Object.assign(r,t),o.push(r),pushLine(),h=0,a=0):(t=s.measureText(r,i,n),h=Math.max(h,t.height),a=Math.max(a,t.ascent),t.width+c>l&&pushLine(),t.left=c,t.top=u,Object.assign(r,t),c+=t.width,o.push(r))}pushLine();let f=p[p.length-1],m=s.measureText(f,i,n);return h=Math.max(h,m.height),a=Math.max(a,m.ascent),m.left=r.left,m.top=u,Object.assign(f,m),o.push(f),pushLine(),[d,p]}}let g=0;function setLastFontLoadedTime(e){g=e}function runLength(e){return e.map((e=>e.text)).reduce(((e,t)=>t.length+e),0)}class Doc{constructor(){this.runs=[],this.intervals=[],this.selections={},this.defaultFont="Roboto",this.defaultSize=10}load(e){this.canonicalize(e)}setDefault(e,t){this.defaultFont=e||this.defaultFont,this.defaultSize=t||this.defaultSize}doEvent(e){"insert"===e.type?this.doInsert(e.user,e.runs):"delete"===e.type?this.doDelete(e.user,e.backspace):"select"===e.type?this.doSelect(e.user,e.start,e.end,e.isBol):"setStyle"===e.type&&this.doSetStyle(e.user,e.style,e.merge)}doInsert(e,t){let s=this.ensureSelection(e),i=t.length>0&&"\n"===t[t.length-1].text;if(s.start===s.end){let[n,r]=this.findRun(s.start),l=this.intervals[r];l.end!==s.start&&l.start!==s.start?(this.splitRunAt(r,s.start-l.start),r+=1):l.end===s.start&&(r+=1),this.runs.splice(r,0,...t),this.canonicalize(this.runs,l.start),this.updateSelectionsInsert(e,s.start,runLength(t),i)}else this.doDelete(e,!0),this.doInsert(e,t)}doDelete(e,t){let s,i,n=this.ensureSelection(e),r=this.length();if(n.start===n.end){if(!t&&n.start===r||t&&0===n.start)return;t?(s=n.start-1,i=n.end):(s=n.start,i=n.end+1)}else s=n.start,i=n.end;let[l,o]=this.findRun(s),h=this.intervals[o];h.end!==s&&(this.splitRunAt(o,s-h.start),o+=1);let[a,d]=this.findRun(i),c=this.intervals[d],u=i-c.start;i!==c.end&&0!==u?(this.splitRunAt(d,u),d+=1):i===c.end&&(d+=1),this.runs.splice(o,d-o),this.canonicalize(this.runs),this.updateSelectionsDelete(e,s,i)}doSelect(e,t,s,i){this.selections[e.id]={start:t,end:s,isBol:i,color:e.color}}doSetStyle(e,t,s){let i=this.selections[e.id];if(i.start===i.end)return;let n=i.start,r=i.end,[l,o]=this.findRun(n),h=this.intervals[o];h.start!==n&&this.splitRunAt(o,n-h.start),[l,o]=this.findRun(r),h=this.intervals[o],h.end!==r&&this.splitRunAt(o,r-h.start);let a=n,d=0;for(;a<r&&d<1e4;)if(d++,[l,o]=this.findRun(a),h=this.intervals[o],h.end<=r){let e=s?{...l.style,...t}:{...t};l.style=e,a=h.end}this.canonicalize(this.runs)}length(){return this.intervals[this.intervals.length-1].end-1}copyRun(e){if(!e)return e;let t={};return t.text=e.text,e.style&&(t.style=e.style),t}canonicalize(e){let t=[],s=[],i=0,addEOF=()=>{t.push({text:m}),s.push({start:i,end:i+1})};if(0===e.length)return addEOF(),this.runs=t,void(this.intervals=s);let n=this.copyRun(e[0]),r=1,l=this.copyRun(e[r]);for(;l&&l.text!==m;){if(equalStyle(n.style,l.style))n.text+=l.text;else{let e=i+n.text.length,r={start:i,end:e};i=e,t.push(n),s.push(r),n=l}r++,l=this.copyRun(e[r])}let o=i+n.text.length,h={start:i,end:o};t.push(n),s.push(h),i=o,t[t.length-1].text!==m&&addEOF(),this.runs=t,this.intervals=s}styleAt(e){let[t,s]=this.findRun(e);return t.style}save(e,t){let s,i,n,r,l,o,h,a=this.runs,d=this.intervals,c=void 0!==e?e:0,u=void 0!==t?t:this.length();if([s,i]=this.findRun(c),[n,r]=this.findRun(u),i===r)return h=d[i],o=this.copyRun({text:s.text.slice(c-h.start,u-h.start)}),[o];let p=[];l=s,h=d[i],o=this.copyRun({text:l.text.slice(c-h.start)},!0),p.push(o);for(let e=i+1;e<=r-1;e++)o=this.copyRun(a[e]),p.push(o);return h=d[r],o=this.copyRun({text:n.text.slice(0,u-h.start)}),o.text!==m&&p.push(o),p}plainText(e,t){return this.save(e,t).map((e=>e.text)).join("")}splitRunAt(e,t){let s=this.runs[e],i=this.intervals[e],n=this.copyRun({text:s.text.slice(0,t),style:s.style}),r=this.copyRun({text:s.text.slice(t,s.text.length),style:s.style});this.runs.splice(e,1,n,r),n={start:i.start,end:i.start+t},r={start:i.start+t,end:i.end},this.intervals.splice(e,1,n,r)}findRun(e){let t,s=this.runs,i=this.intervals;for(let n=0;n<s.length;n++)if(t=i[n],t.start<=e&&e<t.end)return[s[n],n];return e===t.end?[s[s.length-1],s.length-1]:[null,null]}updateSelectionsInsert(e,t,s,i){for(let n in this.selections){let r=this.selections[n];n===e.id?this.selections[n]={start:t+s,end:t+s,isBol:i,color:e.color}:t<r.start?this.selections[n]={start:r.start+s,end:r.end+s,isBol:i,color:r.color}:r.start<t&&t<r.end&&(this.selections[n]={start:r.start,end:r.end+s,isBol:i,color:r.color})}}updateSelectionsDelete(e,t,s){let i=s-t;for(let n in this.selections){let r=this.selections[n];n===e.id?this.selections[n]={start:t,end:t,color:e.color}:s<=r.start?this.selections[n]={start:r.start-i,end:r.end-i,color:r.color}:r.end<=t||(t<=r.start&&r.end<=s?this.selections[n]={start:t,end:t,color:r.color}:t<r.start&&s<r.end?this.selections[n]={start:t,end:r.end-i,color:r.color}:r.start<=t&&s<r.end?this.selections[n]={start:r.start,end:r.end-i,color:r.color}:r.start<=t&&t<r.end&&(this.selections[n]={start:r.start,end:t,color:r.color}));let[l,o]=this.findRun(this.selections[n].start-1);this.selections[n].isBol=l&&isNewline(l.text[l.text.length-1])}}setSelections(e){this.selections=JSON.parse(JSON.stringify(e))}getSelections(){return JSON.parse(JSON.stringify(this.selections))}ensureSelection(e){let t=this.selections[e.id];return t||(t={start:0,end:0,color:e.id},this.selections[e.id]=t),t}snapshotFrom(e,t,s){return{type:"snapshot",user:t,content:{runs:e.runs,selections:JSON.parse(JSON.stringify(e.selections))},timezone:s}}undoEvent(e,t,s){let i=t.queue,n=e.user;let r=function findLast(t,s){for(let i=t.length-1;i>=0;i--)if(t[i].user.id===s.user.id&&t[i].timezone===e.timezone&&"snapshot"!==t[i].type)return i;return-1}(i,e);if(r<0)return t.timezone;let l=i[r],o=function findSnapshot(e,t){for(;t>=0;t--)if("snapshot"===e[t].type)return t;return-1}(i,r);if(o<0)return t.timezone;let h=i[o].content;s.load(h.runs),s.setSelections(h.selections);let a=[];for(let e=0;e<=o;e++)a.push(i[e]);for(let e=o+1;e<r;e++)s.doEvent(i[e]),a.push(i[e]);for(let e=r+1;e<i.length;e++)"snapshot"!==i[e].type&&(s.doEvent(i[e]),a.push(i[e]));return t.timezone++,l.timezone=t.timezone,t.undoStacks[n.id]||(t.undoStacks[n.id]=[]),t.undoStacks[n.id].push(l),t.selections=s.getSelections(),t.runs=s.save(),t.queue=a,t.timezone}receiveEditEvents(e,t,s){let i=t.queue,n=e[0].user;if(t.timezone%10==0&&i.push(this.snapshotFrom(t,n,t.timezone)),t.timezone++,i.length>0&&i[i.length-1].timezone>e[0].timezone+60)return[t.timezone,!1];function transform(e,t){if("select"===e.type){if("insert"===t.type)return t.pos<=e.start?{...e,start:e.start+t.length,end:e.end+t.length}:e.start<=t.pos&&t.pos<=e.end?{...e,end:e.end+t.length}:e;if("delete"===t.type){if(e.end<=t.start)return e;if(t.start<=e.start&&e.end<=t.end)return{...e,start:t.start,end:t.start};if(t.end<=e.start)return e;if(e.start<=t.start&&e.end<t.end)return{...e,end:t.start};if(t.start<=e.start&&t.end<e.end)return{...e,start:t.start,end:e.end-t.end}}if("select"===t.type)return e}return e}let r=[],l={...t.selections},o=function findFirst(e,t){if(0===e.length)return 0;if(e[i.length-1].timezone<t.timezone)return e.length;for(let s=e.length-1;s>=0;s--)if(e[s].timezone<t.timezone)return s+1;return 0}(i,e[0]);e.forEach((e=>{let s=e;if(o>=0)for(let e=o;e<i.length;e++)s=transform(s,i[e]);s.timezone=t.timezone,r.push(s)})),i.push(...r),o=i.findIndex((e=>e.timezone>t.timezone-60));for(let e=i.length-1;e>=0;e--){delete l[i[e].user.id]}for(let e in l)delete t.selections[e],delete t.undoStacks[e];i.splice(0,o),s.setSelections(t.selections);let h=!1;return r.forEach((e=>{h=h||"insert"===e.type||"delete"===e.type,s.doEvent(e)})),t.runs=s.save(),t.selections=s.getSelections(),[t.timezone,h]}}class Warota{constructor(e,t){this.doc=t||new Doc,this._width=0,e.margins?this.margins=e.margins:this.margins=e.margins={left:0,top:0,right:0,bottom:0},this.options=e,this.scrollLeft=0,this.scrollTop=0,this.relativeScrollBarWidth=.02,this.showsScrollbar=e.showScrollBar,this.isScrollable=!0,this.resize(e.width,e.height),this.resizeToNumLinesOrFontSize(e),this.events=[],this.timezone=0}resetEvents(){this.events=[]}width(e){return void 0===e?this._width:(this._width=e,null)}setTimezone(e){this.timezone=e}resize(e,t){this.screenWidth=e,this.screenHeight=t}resizeToNumLinesOrFontSize(e){this.defaultMeasurer=new Measurer;let t=this.defaultMeasurer.lineHeight(e.font,e.fontSize),s=e.margins.top+e.margins.bottom,i=e.height-s;e.fontSize?e.numLines=i/e.fontSize:(e.numLines||(e.numLines=10),e.fontSize=i/e.numLines);let n=e.numLines*t,r=e.fontSize/t,l=n+s*r;this.pixelY=l;let o=l/this.screenHeight;this.pixelX=this.screenWidth*o,this.pixelX*this.relativeScrollBarWidth<=30&&(this.relativeScrollBarWidth=30/this.pixelX),this.width(this.pixelX*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0))),this.lineHeight=t,this.pixelMargins={left:e.margins.left/r,right:e.margins.right/r,top:e.margins.top/r,bottom:e.margins.bottom/r},e.pixelMargins=this.pixelMargins}resetMeasurer(){this.defaultMeasurer=new Measurer}layout(){(void 0===this.lastFontLoadedTimeChecked||this.lastFontLoadedTimeChecked<g)&&(this.resetMeasurer(),this.lastFontLoadedTimeChecked=g);let e,t=this.options||{},s=t.singleLine?Number.MAX_VALUE:this._width,i=this.margins.left+this.margins.right,n=this.margins.top+this.margins.bottom,[r,l]=(new Wrap).wrap(this.doc.runs,s,this.defaultMeasurer,this.doc.defaultFont,this.doc.defaultSize,this.pixelMargins);if(this.lines=r,this.words=l,this.hasLastEnter=!1,this.lines.length-2>=0){let e=this.lines[this.lines.length-2],t=e[e.length-1];this.hasLastEnter=isNewline(t.text)}e=t.singleLine?r[0][r[0].length-1]:r[r.length-1][0];let o=this.screenWidth/this.pixelX;t.autoResize?(this.newWidth=(e.left+e.width+i)*o,this.newHeight=(e.top+e.height+n)*o,this.docHeight=e.top+e.height):this.docHeight=e.top+e.height}visibleBounds(){let e=this.docHeight;return{left:this.scrollLeft*this.pixelX,top:this.scrollTop*e,width:this.pixelX,height:this.pixelY}}visibleTextBounds(){let e=this.visibleBounds(),t=e.width*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0)),s=e.height;return{l:e.left,t:e.top,w:t,h:e.height,b:e.top+s,r:e.left+t}}draw(e,t){let{left:s,top:i,width:n,height:r}=t;this.words.forEach((t=>{if(!(t.left+t.width<s||t.top>i+r||t.top+t.height<i||t.left>s+n))if(t.styles){let s=t.left;t.styles.forEach((i=>{e.fillStyle=i.style?i.style:{color:"black"},e.fillText(t.text.slice(i.start,i.end),s,t.top+t.ascent),s+=i.width}))}else e.fillStyle=t.style||"black",e.fillText(t.text,t.left,t.top+t.ascent)}))}drawSelections(e){e.save();for(let t in this.doc.selections){let s=this.doc.selections[t];if(s.end===s.start){e.fillStyle="barSelection "+s.color;let t=this.barRect(s);e.fillRect(t.left,t.top,t.width,t.height)}else{e.fillStyle="boxSelection "+s.color,this.selectionRects(s).forEach((t=>{e.fillRect(t.left,t.top,t.width,t.height)}))}}e.restore()}drawScrollbar(e){let{l:t,t:s,h:i,w:n}=this.scrollbarBounds();e.save(),e.fillStyle="scrollBar",e.fillRect(t,0,n,this.pixelY),e.fillStyle="scrollKnob",e.fillRect(t+3,s,n-6,i),e.restore()}scrollbarBounds(){let{pixelX:e,pixelY:t,scrollTop:s,relativeScrollBarWidth:i}=this,n=t/this.docHeight,r=e*(this.showsScrollbar?i:0),l=t/100*5;return{l:e-r,t:s*t,w:r,h:n>1?t-3:Math.max(l,t*n-6)}}scrollBy(e,t){this.setScroll(this.scrollLeft=e,this.scrollTop+t)}setScroll(e,t){let{pixelY:s,docHeight:i}=this,n=1-s/i;this.scrollTop=Math.max(0,Math.min(n,t))}findLine(e,t,s){let i=this.lines;if(void 0!==t&&void 0!==s){let e=i.findIndex((e=>{let t=e.reduce(((e,t)=>Math.max(e,t.height)),0),i=e[0];return i.top<=s&&s<i.top+t}));return e<0&&(e=i.length-1),[i[e],e]}let n=i.findIndex((t=>{let s=t[0],i=t[t.length-1];return s.start<=e&&e<i.end}));return n<0&&(n=i.length-1),[i[n],n]}findWord(e,t,s){if(void 0!==t&&void 0!==s){let[i,n]=this.findLine(e,t,s),r=i.findIndex((e=>e.left<=t&&t<e.left+e.width));return r<0&&(r=t<i[0].left?0:i.length-1),i[r]}let[i,n]=this.findLine(e,t,s),r=i.findIndex((t=>t.start<=e&&e<t.end));return r<0&&(r=t<i[0].left?0:i.length-1),i[r]}insert(e,t){let s=Event.insert(e,t,this.timezone);this.events.push(s)}delete(e,t){let s=Event.delete(e,t,this.timezone);this.events.push(s)}select(e,t,s,i){let n=Event.select(e,t,s,i,this.timezone);this.lastSelect={start:t,end:s},this.events.push(n)}setStyle(e,t,s){let i=Event.setStyle(e,t,s);this.events.push(i)}doEvent(e){this.doc.doEvent(e),this.layout()}positionFromIndex(e){let t=this.findWord(e);if(0===e&&t.text===m){let e=this.margins||{};return{left:0+(e.left||0),top:0+(e.top||0),width:0,height:t.height}}let s=e-t.start,i={...t};i.text=t.text.slice(0,s);let n=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize);i.text=t.text.slice(0,s+1);let r=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize);return{left:t.left+n.width,top:t.top,width:r.width-n.width,height:t.height}}indexFromPosition(e,t){let s=this.findWord(null,e,t),i=0,n=e-s.left;if(n<0)return s.start;if(s.text===m)return s.start;if(isNewline(s.text))return s.start;let r={...s};for(let e=0;e<=s.text.length;e++){let t;r.text=s.text.slice(0,0!==e?e:1),t=this.defaultMeasurer.measureText(r,this.doc.defaultFont,this.doc.defaultSize);let l=(t.width-i)/2;if(i<=n&&n<i+l)return s.start+(0===e?0:e-1);if(i+l<=n&&n<t.width)return s.start+e;i=t.width}return s.end}isBol(e,t){let[s,i]=this.findLine(null,e,t),n=s[0];if(e<n.left)return!0;if(n.text===m)return this.hasLastEnter;let r={...n};r.text=n.text.slice(0,1);let l=this.defaultMeasurer.measureText(r,this.doc.defaultFont,this.doc.defaultSize).width/2;return e-n.left<l}changeLine(e,t,s){let[i,n]=this.findLine(t);if(s>0&&n===this.lines.length-2)return this.hasLastEnter?this.lines[this.lines.length-1][0].start:t;let r=this.positionFromIndex(t),l=n+s;if(l<0)return 0;if(l>=this.lines.length)return this.lines[this.lines.length-1][0].start;let o=this.lines[l];return 1!==o.length||1!==o[0].text.length||"\n"!==o[0].text&&"\r"!==o[0].text?this.indexFromPosition(r.left,o[0].top):o[0].start}lineHeightAt(e){if(0===this.doc.length())return this.defaultMeasurer.measureText({text:"x"},this.doc.defaultFont,this.doc.defaultSize).height;let[t,s]=this.findLine(e);return t.reduce(((e,t)=>Math.max(t.height,e)),0)}barRect(e){let t=e.start;if(0===t){let e=this.positionFromIndex(t),s=this.lineHeightAt(t);return{left:e.left-1,top:e.top,width:2,height:s}}if(t===this.doc.length()){if(e.isBol){let e=this.positionFromIndex(t),s=this.lineHeightAt(t);return{left:e.left-1,top:e.top,width:2,height:s}}let[s,i]=this.findLine(t-1);t=s[s.length-1].end-1;let n=this.positionFromIndex(t),r=this.lineHeightAt(t);return{left:n.left+n.width-1,top:n.top,width:2,height:r}}let s=this.positionFromIndex(t),i=this.lineHeightAt(t);return e.isBol,{left:s.left-1,top:s.top,width:2,height:i}}selectionRects(e){let{start:t,end:s}=e,[i,n]=this.findLine(t),[r,l]=this.findLine(s);if(void 0===i||void 0===r)return[];if(n===l){let e=this.positionFromIndex(t),i=this.positionFromIndex(s),n=this.lineHeightAt(t);return[{left:e.left,top:e.top,width:i.left-e.left,height:n}]}let o,h,a=[],d=this.positionFromIndex(t),c=this.lineHeightAt(t);if(s===this.doc.length()){let e=this.findWord(s-1);if(isNewline(e.text[e.length-1])){s--;let[e,t]=this.findLine(s);r=e,l=t}}return o=this.positionFromIndex(s),h=this.lineHeightAt(s),a.push({left:d.left,top:d.top,width:this.width()-d.left,height:c}),l-n>=2&&(d=this.lines[n+1][0],a.push({left:this.pixelMargins.left,top:d.top,width:this.width(),height:o.top-d.top})),d=this.lines[l][0],h=this.lineHeightAt(s),a.push({left:this.pixelMargins.left,top:o.top,width:o.left-this.pixelMargins.left,height:h}),a}isScrollbarClick(e,t){if(!this.showsScrollbar)return!1;let s=this.relativeScrollBarWidth*this.pixelX;return e>=this.pixelX-s-3}mouseDown(e,t,s,i){if(this.isScrollbarClick(e,t))this.scrollBarClick={type:"clicked",scrollBarVOffset:t-this.scrollbarBounds().t,scrollBarTopOnDown:this.scrollTop,realStartY:s,startX:e,startY:t};else{let s=this.indexFromPosition(e,t),n=this.isBol(e,t);this.extendingSelection=null,this.selectDragStart=s,this.select(i,s,s,n)}this.keyboardX=null}mouseMove(e,t,s,i){if(null!==this.selectDragStart){let s,n,r=this.indexFromPosition(e,t);if(r||0===r){this.focusChar=r,this.selectDragStart>r?(this.extendingSelection="top",s=r,n=this.selectDragStart):(this.extendingSelection="bottom",s=this.selectDragStart,n=r);let e=this.lastSelect;if(e&&(e.start!==s||e.end!==n))return this.select(i,s,n),"selectionChanged"}return null}if(this.scrollBarClick){let{realStartY:e,scrollBarTopOnDown:t}=this.scrollBarClick,i=this.docHeight,n=(s-e)*Math.max(1,i/this.pixelY)/i+t;return this.scrollBarClick.type="move",this.setScroll(0,n),"scrollChanged"}return null}mouseUp(e,t,s,i){this.scrollBarClick?(this.scrollBarClick.type,this.scrollBarClick=null,this.wasScrollBarClick=!0):this.wasScrollBarClick=!1,this.selectDragStart=null,this.keyboardX=null,this.lastSelect=null}backspace(e){this.delete(e,!0)}handleKey(e,t,s,i){let n,r,l=this.doc.selections[e.id]||{start:0,end:0,color:e.color},{start:o,end:h,isBol:a}=l,d=this.doc.length(),c=!1;if(s){if(!this.keyboardSelect)switch(t){case 37:case 38:case 36:case 33:this.keyboardSelect=-1;break;case 39:case 40:case 35:case 34:this.keyboardSelect=1}}else this.keyboardSelect=0;let u,p=1===this.keyboardSelect?h:o,f=p,m=!1;switch(t){case 37:s||o===h?p>0&&p--:p=o,a=!1,m=!0;break;case 39:if(s||o===h){if(p<d){let[e,t]=this.findLine(p);n=e,r=t,p++}}else p=h;m=!0;break;case 40:{let[t,s]=this.findLine(p);n=t,r=s,p=this.changeLine(e,p,1),u=f===p,m=!0}break;case 38:p=this.changeLine(e,p,-1),a=!1,m=!0;break;case 8:case 46:this.backspace(e),c=!0}if(m){switch(this.keyboardSelect){case 0:o=h=p;break;case-1:o=p;break;case 1:h=p}if(o===h&&(this.keyboardSelect=0),o>h){this.keyboardSelect=-this.keyboardSelect;let e=h;h=o,o=e}let t;if(n){let[e,s]=this.findLine(p);t=s,a=r!==t&&this.hasLastEnter||u}this.select(e,o,h,a),c=!0}if(i)switch(t){case 65:this.select(e,0,d),window.editor=this,c=!0}return c}selectionText(e){let t=this.doc.selections[e.id];return t?this.doc.plainText(t.start,t.end):""}}class Event{static insert(e,t,s){return{type:"insert",user:e,runs:t,length:runLength(t),timezone:s}}static delete(e,t,s){return{type:"delete",backspace:t,user:e,timezone:s}}static select(e,t,s,i,n){return{type:"select",user:e,start:t,end:s,isBol:i,timezone:n}}static setStyle(e,t,s){return{type:"setStyle",user:e,style:t,merge:s}}}class TextElement extends Element{static types(){return{"Warota.Doc":Doc}}static viewClass(){return TextView}init(){super.init(),this.doc=new Doc,this.doc.load([]),this.content={runs:[],selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},this.subscribe(this.id,"editEvents","receiveEditEvents"),this.subscribe(this.id,"accept","publishAccept"),this.subscribe(this.id,"undoRequest","undoRequest"),this.subscribe(this.id,"setWidth","setWidth"),this.subscribe(this.sessionId,"view-exit","viewExit"),this.setStyleClasses("\n.text-no-select {\n    user-select: none;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n}\n\n.text-div {\n    width: 100%;\n    white-space: nowrap;\n    pointer-events: none;\n}\n        "),this._set("contenteditable",!0)}bePartsBinPrototype(){super.bePartsBinPrototype(),this.setWidth(200)}setWidth(e){let t=e+"px";this.style.setProperty("width",t)}load(e){let t;t="string"==typeof e?[{text:e}]:e,this.doc.load(t),this.publishChanged(),this.needsUpdate()}save(){return{runs:this.doc.runs,defaultFont:this.doc.defaultFont,defaultSize:this.doc.defaultSize}}loadAndReset(e){let t=[{text:e}];this.content={runs:t,selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},this.doc.load(t),this.publishChanged(),this.needsUpdate()}receiveEditEvents(e){let[t,s]=this.doc.receiveEditEvents(e,this.content,this.doc);s&&this.publishChanged(),this.publish(this.id,"screenUpdate",t),this.needsUpdate()}publishAccept(){this.publish(this.id,"text",{ref:this.asElementRef(),text:this.doc.plainText()})}publishChanged(){this.publish(this.id,"changed",{ref:this.asElementRef()})}viewExit(e){delete this.content.selections[e],this.needsUpdate()}undoRequest(e){let t,s=this.content.queue;for(let i=s.length-1;i>=0;i--){let n=s[i];if(n.user.id===e.id&&"snapshot"!==n.type&&"select"!==n.type){t=s[i];break}}if(!t)return;let i=this.doc.undoEvent(t,this.content,this.doc);this.publish(this.id,"screenUpdate",i)}setDefault(e,t){return this.doc.setDefault(e,t)}styleAt(e){return this.doc.styleAt(e)}get value(){return this.doc.plainText()}set value(e){return this.load(e)}set contenteditable(e){this._set("contenteditable",e)}get contenteditable(){return this._get("contenteditable")}}TextElement.register("TextElement");class TextView extends ElementView{constructor(e){super(e),this.subscribe(this.model.id,"screenUpdate","screenUpdate"),this.divs=[],this.widgets={};let t=document.createElement("div");t.id="holder",this.holder=t,this.holder.style.setProperty("position","relative"),this.dom.style.setProperty("overflow","hidden"),t.innerHTML='\n     <div class="textPane" style="width: 100%; height: 100%; position: absolute;"></div>\n     <div class="selectionPane" style="position: absolute; top: 0px; left: 0px; width: 0px; height: 0px"></div>\n',this.dom.appendChild(t),this.text=t.querySelector(".textPane"),this.selectionPane=t.querySelector(".selectionPane"),this.hiddenInput=document.createElement("input"),this.hiddenInput.style.setProperty("position","absolute"),this.hiddenInput.style.setProperty("left","-120px"),this.hiddenInput.style.setProperty("top","-120px"),this.hiddenInput.style.setProperty("transform","scale(0)"),this.hiddenInput.style.setProperty("z-order","10"),this.hiddenInput.style.setProperty("width","100px"),this.hiddenInput.style.setProperty("height","100px"),document.body.appendChild(this.hiddenInput),this.setup()}test(){}setup(){let e=this.model.style.getPropertyValue("-cards-text-margin"),t={width:800,height:800,font:this.model.doc.defaultFont,fontSize:this.model.doc.defaultSize};if(e){let s=e.split(" ");t.margins={},["top","right","bottom","left"].forEach(((e,i)=>{t.margins[e]=parseFloat(s[i])})),this.text.style.setProperty("margin",e)}var s;this.singleLine=this.model.style.getPropertyValue("-cards-text-singleLine"),this.singleLine&&(t.singleLine=!0),this.warota=new Warota(t,this.model.doc),this.options=t,this.user={id:this.viewId,color:(s=this.viewId,`hsl(${Math.floor(parseInt(s,36)/(10**36/360))}, 40%, 40%)`)},this.selections={},this.dom.addEventListener("pointerdown",(e=>{e.stopPropagation(),window.topView.grabber.capturePointer(e.pointerId,e.target),this.pointerDown(this.cookEvent(e))}),!0),this.text.addEventListener("pointerdown",(e=>{e.stopPropagation(),window.topView.grabber.capturePointer(e.pointerId,e.target),this.pointerDown(this.cookEvent(e))}),!0),this.text.addEventListener("pointermove",(e=>{e.stopPropagation(),this.pointerMove(this.cookEvent(e))}),!0),this.text.addEventListener("pointerup",(e=>{e.stopPropagation(),this.pointerUp(this.cookEvent(e))}),!0),this.dom.addEventListener("pointerup",(e=>{e.stopPropagation(),this.pointerUp(this.cookEvent(e))}),!0),this.dom.addEventListener("dblclick",(e=>{e.stopPropagation()}),!0),this.text.key=this.dom.key,this.dom.addEventListener("pointercancel",(e=>this.pointerUp(this.cookEvent(e)))),this.dom.addEventListener("lostpointercapture",(e=>this.pointerUp(this.cookEvent(e)))),this.hiddenInput.addEventListener("input",(e=>this.input(e)),!0),this.hiddenInput.addEventListener("keydown",(e=>this.keyDown(e)),!0),this.hiddenInput.addEventListener("copy",(e=>this.copy(e))),this.hiddenInput.addEventListener("cut",(e=>this.cut(e))),this.hiddenInput.addEventListener("paste",(e=>this.paste(e))),this.subscribe(this.viewId,"synced","synced"),this.isSynced=!1,this.screenUpdate(this.warota.timezone),this.isSynced=!0}detach(){super.detach(),console.log("textview detach"),this.hiddenInput&&this.hiddenInput.remove()}setKey(e){super.setKey(e),this.text.key=e}setWidth(e){this.publish(this.model.id,"setWidth",e),this.width(e)}width(e){this.text.style.setProperty("width",e+"px"),this.warota.width(e),this.screenUpdate(this.warota.timezone)}synced(e){this.isSynced=e,this.isSynced&&(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone))}accept(){this.publish(this.model.id,"accept")}apply(e,t,s){super.apply(e,t,s);let i=t.style.getPropertyValue("width");if(this.width(parseInt(i,10)),this._lastValues.get("enterToAccept")!==this.model._get("enterToAccept")){let e=this.model._get("enterToAccept");this._lastValues.set("enterToAccept",e),e?(this.dom.style.setProperty("overflow","hidden"),this.text.style.setProperty("overflow","hidden")):(this.dom.style.removeProperty("overflow"),this.text.style.removeProperty("overflow"))}this.screenUpdate(this.warota.timezone)}cookEvent(e){e.preventDefault();let t=e.offsetX,s=e.offsetY,i=this.warota.margins;return i&&(t+=i.left,s+=i.top),{x:t,y:s,target:e.target.key}}pointerDown(e){this.hiddenInput.focus(),this.warota.mouseDown(e.x,e.y,e.y,this.user),this.changed()}pointerMove(e){this.warota.mouseMove(Math.max(e.x,0),e.y,e.y,this.user),this.changed()}pointerUp(e){this.warota.mouseUp(e.x,e.y,e.y,this.user),this.changed(),window.topView.grabber.releasePointer()}newCanonicalizeEvent(e){if("input"===e.type&&"insertText"===e.inputType&&!e.isComposing){let t=this.hiddenInput.value;return this.hiddenInput.value="",{keyCombo:"",key:t,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:e.type,keyCode:e.keyCode}}return null}eventFromField(){let e=this.hiddenInput.value;return this.hiddenInput.value="",{keyCombo:"",key:e,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:"",keyCode:0}}simpleInput(e,t){if(!this.model._get("contenteditable"))return!1;let s=this.user,i=this.model.content.selections[this.viewId],n=this.model.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:e,style:n}]),this.changed(!0),t.preventDefault(),!0}input(e){if(!this.model._get("contenteditable"))return!1;let t=this.newCanonicalizeEvent(e);if(!t)return!1;let s=this.user,i=this.model.content.selections[this.viewId],n=this.model.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:t.key,style:n}]),this.changed(!0),e.preventDefault(),!0}keyDown(e){let t;if(!this.model._get("contenteditable"))return!1;"Enter"===e.key&&""!==this.hiddenInput.value?this.hiddenInput.value="":t=canonicalizeKeyboardEvent(e);let s=this.user;if(!t)return!0;if(t.onlyModifiers)return!0;if("Meta-S"===t.keyCombo||"Ctrl-S"===t.keyCombo)return this.accept(),e.preventDefault(),!0;if("Meta-Z"===t.keyCombo||"Ctrl-Z"===t.keyCombo)return this.undo(),e.preventDefault(),!0;if(13===t.keyCode)return this.model._get("enterToAccept")?(e.preventDefault(),this.accept(),!0):this.simpleInput("\n",e);if(32===t.keyCode)return this.simpleInput(" ",e);if(9===t.keyCode)return this.simpleInput("\t",e);const i=this.warota.handleKey(s,t.keyCode,t.shiftKey,t.ctrlKey||t.metaKey);return i||t.ctrlKey||t.metaKey?(i&&(e.preventDefault(),this.changed(!0)),!1):(this.warota.insert(s,[{text:t.key}]),this.changed(!0),e.preventDefault(),!0)}copy(e){let t=this.warota.selectionText(this.user);return e.clipboardData.setData("text/plain",t),e.preventDefault(),!0}cut(e){return this.copy(e),this.warota.insert(this.user,[{text:""}]),this.changed(!0),!0}paste(e){let t=e.clipboardData.getData("text");return this.warota.insert(this.user,[{text:t}]),e.preventDefault(),this.changed(!0),!0}undo(){this.publish(this.model.id,"undoRequest",this.user)}changed(e){let t=this.warota.events;this.warota.resetEvents(),t.length>0&&(this.scrollNeeded=!this.singleLine&&e,this.publish(this.model.id,"editEvents",t))}screenUpdate(e){this.warota.timezone=e,this.isSynced&&(this.warota.layout(),this.showText(),this.showSelections(),this.setHeight(),this.scrollNeeded&&(this.scrollNeeded=!1,this.scrollSelectionToView()))}ensureDiv(e){let t;if(e<this.divs.length)for(t=this.divs[e];t.firstChild;)t.lastChild.remove();else t=document.createElement("div"),t.classList.add("text-no-select","text-div","no-pointer"),this.text.appendChild(t),this.divs[e]=t;return t}spanFor(e,t){let s=document.createElement("span");if(s.classList.add("text-no-select"),t&&(t.color&&s.style.setProperty("color",t.color),t.size&&s.style.setProperty("font-size",t.size+"px"),t.font&&s.style.setProperty("font-family",t.font),t.bold&&s.style.setProperty("font-weight","700"),t.italic&&s.style.setProperty("font-style","italic"))," "===e||"\n"===e||"\r"===e)s.textContent="";else if("\t"===e)s.classList.add("tab");else{if(e===m)return null;s.textContent=e}return s}showText(){let e;this.warota.lines.forEach(((t,s)=>{e=s;let i=this.ensureDiv(s);t.forEach((e=>{if(e.styles)e.styles.forEach((t=>{let{start:s,end:n,style:r}=t,l=this.spanFor(e.text.slice(s,n),r);l&&i.appendChild(l)}));else{let t=this.spanFor(e.text,e.style);t&&i.appendChild(t)}}))}));for(let t=e+1;t<this.divs.length;t++)this.divs[t].remove();this.divs.splice(e+1)}setStyle(e){this.warota.setStyle(this.user,e,!1),this.changed()}mergeStyle(e){this.warota.setStyle(this.user,e,!0),this.changed()}setHeight(){this.text.style.setProperty("height",this.warota.docHeight+"px"),this.holder.style.setProperty("height",this.warota.docHeight+"px")}ensureSelection(e){let t=this.selections[e];if(!t){let s=document.createElement("div");s.classList.add("caret"),s.style.setProperty("pointer-events","none"),s.style.setProperty("position","absolute"),this.selectionPane.appendChild(s),t={bar:s,boxes:[0,1,2].map((e=>{let t=document.createElement("div");return t.classList.add("selection"),t.style.setProperty("visibility","hidden"),t.style.setProperty("pointer-events","none"),t.style.setProperty("position","absolute"),this.selectionPane.appendChild(t),t}))},this.selections[e]=t}return t}showSelections(){let e={};for(let t in this.selections)e[t]=this.selections[t];for(let t in this.model.content.selections){delete e[t],this.ensureSelection(t).boxes.forEach((e=>e.style.setProperty("visibility","hidden")));let s=this.model.content.selections[t],i=this.ensureSelection(t).bar;if(s.end===s.start){this.model._get("contenteditable")?i.style.removeProperty("visibility"):i.style.setProperty("visibility","hidden");let e=this.warota.barRect(s);i.style.setProperty("left",e.left+"px"),i.style.setProperty("top",e.top+"px"),i.style.setProperty("width",e.width+"px"),i.style.setProperty("height",e.height+"px"),i.style.setProperty("background-color",s.color),i.style.setProperty("opacity",t===this.viewId?"0.5":"0.25")}else{i.style.setProperty("visibility","hidden");let e=this.warota.selectionRects(s);for(let i=0;i<3;i++){let n=this.ensureSelection(t).boxes[i],r=e[i];r?(n.style.setProperty("left",r.left+"px"),n.style.setProperty("top",r.top+"px"),n.style.setProperty("width",r.width+"px"),n.style.setProperty("height",r.height+"px"),n.style.setProperty("background-color",s.color),n.style.setProperty("opacity",t===this.viewId?"0.25":"0.08"),n.style.removeProperty("visibility")):n.style.setProperty("visibility","hidden")}}}for(let t in e)this.selections[t].bar.remove(),this.selections[t].boxes.forEach((e=>e.remove())),delete this.selections[t];this.publish(this.id,"selectionUpdated")}scrollSelectionToView(){let e=this.dom.scrollTop,t=parseFloat(this.dom.style.getPropertyValue("height")),s=this.model.content.selections[this.viewId];if(!s)return;if(s.end!==s.start)return;let i=this.warota.barRect(s);i.top+i.height>t+e?this.dom.scrollTop=i.top+i.height-t:i.top<e&&(this.dom.scrollTop=i.top)}addWidget(e,t){this.widgets[e]&&this.removeWidget(e,t),this.widgets[e]=t,this.selectionPane.appendChild(t)}removeWidget(e,t){delete this.widgets[e],t.remove()}}const w=["src","allow","importance","name","referrerpolicy","sandbox","width","height"];class IFrameElement extends Element{static viewClass(){return IFrameView}bePartsBinPrototype(){super.bePartsBinPrototype(),this.style.setProperty("width","600px"),this.style.setProperty("height","400px"),this.style.setProperty("border","5px solid blue"),this._set("src","")}_set(e,t){let s=this._get(e);super._set(e,t),w.indexOf(e)>=0&&(s===t&&"src"!==e||this.needsUpdate())}}IFrameElement.register("IFrameElement");class IFrameView extends ElementView{createDom(){return this.iframe=document.createElement("iframe"),this.iframe}apply(e,t,s){super.apply(e,t,s);let i=this.iframe.parentNode,n=this.iframe.nextSibling,r=w.filter((e=>{let s=t._get(e);return this._lastValues[e]!==s||"src"===e&&"string"==typeof s})).map((e=>[e,t._get(e)]));try{i&&this.iframe.remove(),r.forEach((([e,t])=>{this._lastValues.set(e,t),this.iframe[e]=t}))}catch(e){console.log("may be some unknown attributes are specified",e)}finally{i&&i.insertBefore(this.iframe,n)}}}class VideoElement extends Element{static viewClass(){return VideoView}bePartsBinPrototype(){super.bePartsBinPrototype(),this.style.setProperty("width","300px"),this.style.setProperty("height","200px"),this.style.setProperty("border","5px solid blue")}}VideoElement.register("VideoElement");class VideoView extends ElementView{createDom(){return document.createElement("video")}play(){return this.dom.play()}set srcObject(e){return this.dom.srcObject=e}get srcObject(){return this.dom.srcObject}set muted(e){return this.dom.muted=e}get muted(){return this.dom.muted}set playsInline(e){return this.dom.playsInline=e}get playsInline(){return this.dom.playsInline}apply(e,t,s){super.apply(e,t,s);let i="src",n=t._get(i);this._lastValues.get(i)!==n&&(this._lastValues.set(i,n),this.dom.src=n)}}const v=["alt","crossorigin","height","ismap","loading","longdesc","referrerpolicy","sizes","src","srcset","usemap","width"];class ImageElement extends Element{static viewClass(){return ImageView}bePartsBinPrototype(){super.bePartsBinPrototype(),this.style.setProperty("width","200px"),this.style.setProperty("height","200px"),this._set("width",200),this._set("height",200)}_set(e,t){let s=this._get(e);super._set(e,t),v.indexOf(e)>=0&&(s===t&&"src"!==e||this.needsUpdate())}}ImageElement.register("ImageElement");class ImageView extends ElementView{createDom(){return this.img=document.createElement("img"),this.img.onload=()=>{this.onload&&this.call(...this.onload,this)},this.img.onerror=()=>{this.onerror&&this.call(...this.onerror,this)},this.img}apply(e,t,s){super.apply(e,t,s);let i=v.filter((e=>{let s=t._get(e);return this._lastValues.get(e)!==s})).map((e=>[e,t._get(e)]));try{i.forEach((([e,t])=>{this._lastValues.set(e,t),"src"===e?t?"string"==typeof t?this.img.src=t:Croquet.Data.fetch(this.sessionId,t.handle).then((e=>{const s=new Blob([e],{type:t.type});this._objectURL&&URL.revokeObjectURL(this._objectURL),this._objectURL=URL.createObjectURL(s),this.dom.src=this._objectURL})):(this.dom.removeAttribute("src"),this._objectURL&&URL.revokeObjectURL(this._objectURL)):this.img[e]=t}))}catch(e){console.log("may be some unknown attributes are specified",e)}}}function initializeElementClasses(){!function setKnownElements(e){Element.knownElements=e}({element:Element,canvaselement:CanvasElement,textelement:TextElement,iframeelement:IFrameElement,videoelement:VideoElement,imageelement:ImageElement,div:Element,canvas:CanvasElement,textarea:TextElement,iframe:IFrameElement,video:VideoElement,img:ImageElement}),function setFontLastLoadedTimeFunction(e){o=e}(setLastFontLoadedTime)}function loader(e,t,s,i,n,r,l,o){let h={...r};return o&&(h.options={code:e,json:t}),n(l,s,null,h)}function svgSpriteLoader(e){let t=document.querySelector("#svgIcons");return t?Promise.resolve(null):(t=document.createElement("div"),t.style.setProperty("display","none"),t.id="svgIcons",fetch(e,{method:"GET",mode:"cors",headers:{"Content-Type":"text"}}).then((e=>{if(!e.ok)throw e;return e.text()})).then((e=>(t.innerHTML=e,t))).then((e=>{document.body.appendChild(e)})).catch((t=>console.log("SVG "+e+" not found"))))}function makeMain(e,t,s,i,n,r){let l=`\nreturn function projectCode(parent, json, persistentData) {\n    parent.topChild = true;\n    parent.domId = "top";\n    parent.style.setProperty("position", "relative");\n    parent.style.setProperty("overflow", "hidden");\n    parent.style.setProperty("width", "100%");\n    parent.style.setProperty("height", "100%");\n    let initializer = parent.getLibrary("${e}");\n    let func = new Function(initializer)();\n    func(parent, json, persistentData);\n    return parent;\n}`;return n&&svgSpriteLoader(n),async function main(){initializeElementClasses(),s.installAsBaseLibrary(),function single(e,t,s,i,n){class Model extends TopModel{init(e,t){super.init(e,t),this.future(0).load(e,t)}load(e,t){let s=Element.create();s.beWorld(),s.style.setProperty("height","100%"),s.topChild=!0,s.evaluate(this.initProjectCode(),e.json,e.projectCode,t)}initProjectCode(){return`return function projectCode(parent, json, persistentData) {\n    parent.topChild = true;\n    parent.domId = "top";\n    parent.style.setProperty("position", "relative");\n    parent.style.setProperty("overflow", "hidden");\n    parent.style.setProperty("width", "100%");\n    parent.style.setProperty("height", "100%");\n    let initializer = parent.getLibrary("${i}");\n    let func = new Function(initializer)();\n    func(parent, json, persistentData);\n    return parent;\n}`}initSessionName(){return s}}return Model.register("Model"),s?loader(e,null,Model,0,start,t,s,n):Croquet.App.autoSession("q").then((s=>{loader(e,null,Model,0,start,t,s=`${i}-${s}`,n)}))}(l,t,i,e,r)}}export{Element,ElementView,Library,r as M,TopModel,initializeElementClasses,t as isLocal,loader,makeMain,parse,start,stringify,svgSpriteLoader};
